<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html"><link rel="search" title="Search" href="../../search.html">

    <!-- Generated with Sphinx 8.1.3 and Furo 2025.12.19 -->
        <title>adataviz.utils - adataviz documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/rtd_sphinx_search.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>

<div class="announcement">
  <aside class="announcement-content">
     <em>Documentation website</em> is online! 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">adataviz  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <span class="sidebar-brand-text">adataviz  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../plot.html">Plotting</a><input aria-label="Toggle navigation of Plotting" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/plot.html">Plot embedding (umap or tsne)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/plot.html#Plot-dot-heatmap">Plot dot heatmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/plot.html#Plot-boxplot">Plot boxplot</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../modules.html">adataviz</a><input aria-label="Toggle navigation of adataviz" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../adataviz.html">adataviz package</a><input aria-label="Toggle navigation of adataviz package" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adataviz.plotting.html">adataviz.plotting module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adataviz.tools.html">adataviz.tools module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adataviz.utils.html">adataviz.utils module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../setup.html">setup module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../citation.html">Citation</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for adataviz.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pylab</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.legend_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">HandlerBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.lines</span><span class="w"> </span><span class="kn">import</span> <span class="n">Line2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">Text</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="n">mm2inch</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">25.4</span>

<div class="viewcode-block" id="df2stdout">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.df2stdout">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">df2stdout</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
	<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="serialize">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.serialize">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">serialize</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
		<span class="n">df2stdout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
	<span class="k">elif</span> <span class="ow">not</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">pass</span></div>


<div class="viewcode-block" id="prepare_color_palette">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.prepare_color_palette">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_color_palette</span><span class="p">(</span><span class="n">color_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">outpath</span><span class="o">=</span><span class="s2">&quot;palette.xlsx&quot;</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Generating a .xlsx file including all color palette.</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	colors : dict</span>
<span class="sd">		A dict of dict, keys are categorical terms, values are HEX color code</span>

<span class="sd">	Returns</span>
<span class="sd">	-------</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">outpath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span>
	<span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">color_dict</span><span class="p">:</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">color_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Hex&#39;</span><span class="p">])</span>
		<span class="c1"># data.style.background_gradient(cmap=&#39;gray_r&#39;)</span>
		<span class="c1"># data.style.applymap(lambda x:&#39;color:&#39;+x if x.startswith(&#39;#&#39;) else &#39;color: white&#39;)</span>
		<span class="n">data</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">workbook</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">book</span>
		<span class="n">worksheet</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">sheets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="n">colors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Hex</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
			<span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">f</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">})</span>
			<span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
		<span class="n">width</span> <span class="o">=</span> <span class="mi">20</span>
		<span class="n">cell_fmt</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">(</span>
			<span class="p">{</span><span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
			 <span class="c1"># &#39;bg_color&#39;:&#39;green&#39;,</span>
			 <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">})</span>
		<span class="c1"># styled = data.style.applymap(lambda val: &#39;color: %s&#39; % &#39;red&#39; if val &lt; 0 else &#39;black&#39;).highlight_max()</span>
		<span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">cell_fmt</span><span class="p">)</span>
	<span class="c1"># worksheet.conditional_format(f&#39;A:{last_col}&#39;, {&#39;type&#39;: &#39;no_blanks&#39;, &#39;format&#39;: cell_fmt})</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="mpl_style">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.mpl_style">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mpl_style</span><span class="p">():</span>
	<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
	<span class="n">mpl</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
	<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;pdf.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
	<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ps.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
	<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sans-serif&#39;</span>
	<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Arial&#39;</span>
	<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">80</span>
	<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;savefig.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">300</span></div>


<div class="viewcode-block" id="parse_json">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.parse_json">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_json</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
	<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
	<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
	<span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
	<span class="n">R</span><span class="o">=</span><span class="p">[]</span>
	<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]:</span>
		<span class="n">R</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;acronym&#39;</span><span class="p">],</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;color_hex_triplet&#39;</span><span class="p">],</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;parent_structure_id&#39;</span><span class="p">],</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;safe_name&#39;</span><span class="p">],</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;structure_id_path&#39;</span><span class="p">]])</span>
	<span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;acronym&#39;</span><span class="p">,</span><span class="s1">&#39;Hex&#39;</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;parent_structure_id&#39;</span><span class="p">,</span><span class="s1">&#39;safe_name&#39;</span><span class="p">,</span><span class="s1">&#39;structure_id_path&#39;</span><span class="p">])</span>
	<span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="get_brain_region_structure">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.get_brain_region_structure">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_brain_region_structure</span><span class="p">():</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	https://atlas.brain-map.org/</span>
<span class="sd">	BICAN: https://atlas.brain-map.org/atlasviewer/ontologies/11.json</span>
<span class="sd">	HBA: https://atlas.brain-map.org/atlasviewer/ontologies/7.json</span>
<span class="sd">	Returns</span>
<span class="sd">	-------</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1"># pip install XlsxWriter</span>
	<span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s2">&quot;AllenBrainRegionStructure.xlsx&quot;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">url</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;https://atlas.brain-map.org/atlasviewer/ontologies/11.json&#39;</span><span class="p">,</span><span class="s1">&#39;https://atlas.brain-map.org/atlasviewer/ontologies/7.json&#39;</span><span class="p">],[</span><span class="s1">&#39;BICAN_Brodmann&#39;</span><span class="p">,</span><span class="s1">&#39;HBA_guide&#39;</span><span class="p">]):</span>
		<span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="n">df</span><span class="o">=</span><span class="n">parse_json</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
		<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Hex&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="n">df</span><span class="o">.</span><span class="n">Hex</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
		<span class="n">df</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
		<span class="n">id2acronym</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">acronym</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
		<span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;Parent&#39;</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">parent_structure_id</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">id2acronym</span><span class="p">))</span>
		<span class="n">df</span><span class="o">.</span><span class="n">parent_structure_id</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">parent_structure_id</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
		<span class="n">df</span><span class="o">.</span><span class="n">structure_id_path</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">structure_id_path</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">df</span><span class="p">[</span><span class="s1">&#39;structure_path&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">structure_id_path</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="s1">&#39;//&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">id2acronym</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]))</span>
		<span class="c1"># data.style.background_gradient(cmap=&#39;gray_r&#39;)</span>
		<span class="c1"># data.style.applymap(lambda x:&#39;color:&#39;+x if x.startswith(&#39;#&#39;) else &#39;color: white&#39;)</span>
		<span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;Parent&#39;</span><span class="p">,</span><span class="s1">&#39;acronym&#39;</span><span class="p">,</span><span class="s1">&#39;Hex&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;safe_name&#39;</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;parent_structure_id&#39;</span><span class="p">,</span><span class="s1">&#39;structure_path&#39;</span><span class="p">,</span><span class="s1">&#39;structure_id_path&#39;</span><span class="p">]]</span>
		<span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="n">sheet_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="n">workbook</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">book</span>
		<span class="n">worksheet</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">sheets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
		<span class="n">colors</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">Hex</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
		<span class="n">col_idx</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Hex&#39;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
			<span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">f</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">})</span>
			<span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="c1">#worksheet.write(row, col, *args), row and col are 0-based</span>
		<span class="c1"># width=20</span>
		<span class="c1"># cell_fmt = workbook.add_format(</span>
		<span class="c1">#                 {&#39;bold&#39;: False,&#39;font_color&#39;: &#39;black&#39;,</span>
		<span class="c1">#                 # &#39;bg_color&#39;:&#39;green&#39;,</span>
		<span class="c1">#                 &#39;align&#39;: &#39;center&#39;, &#39;valign&#39;: &#39;vcenter&#39;})</span>
		<span class="c1"># # styled = data.style.applymap(lambda val: &#39;color: %s&#39; % &#39;red&#39; if val &lt; 0 else &#39;black&#39;).highlight_max()</span>
		<span class="c1"># worksheet.set_column(0,col_idx,width,cell_fmt) #first_col,last_col</span>
		<span class="c1"># worksheet.conditional_format(f&#39;A:{last_col}&#39;, {&#39;type&#39;: &#39;no_blanks&#39;, &#39;format&#39;: cell_fmt})</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
	<span class="n">df_bican</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">&quot;Jon.xlsx&quot;</span><span class="p">)</span>
	<span class="n">df_bican</span><span class="o">.</span><span class="n">Acronym</span><span class="o">=</span><span class="n">df_bican</span><span class="o">.</span><span class="n">Acronym</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
	<span class="n">regions</span><span class="o">=</span><span class="n">df_bican</span><span class="o">.</span><span class="n">Acronym</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">&quot;AllenBrainRegionStructure.xlsx&quot;</span><span class="p">,</span>
					 <span class="n">sheet_name</span><span class="o">=</span><span class="s2">&quot;BICAN_Brodmann&quot;</span><span class="p">)</span>
	<span class="c1"># df[&#39;Keep&#39;]=df.structure_path.apply(lambda x:[r for r in x.split(&#39;//&#39;) if r in regions])</span>
	<span class="c1"># df=df.loc[df.Keep.apply(len) &gt; 0]</span>
	<span class="c1"># df.drop(&#39;Keep&#39;,axis=1,inplace=True)</span>
	<span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">acronym</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">regions</span><span class="p">)]</span>
	<span class="n">df</span><span class="o">.</span><span class="n">parent_structure_id</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">parent_structure_id</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

	<span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="s2">&quot;BICAN_regions.xlsx&quot;</span><span class="p">)</span>
	<span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s1">&#39;BICAN&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">workbook</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">book</span>
	<span class="n">worksheet</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">sheets</span><span class="p">[</span><span class="s1">&#39;BICAN&#39;</span><span class="p">]</span>
	<span class="n">colors</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">Hex</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="n">col_idx</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Hex&#39;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
		<span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span><span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">})</span>
		<span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="read_google_sheet">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.read_google_sheet">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_google_sheet</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
	<span class="k">assert</span> <span class="ow">not</span> <span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span>
	<span class="c1"># url=&quot;https://docs.google.com/spreadsheets/d/12H3p2F_qrcQ3ymF614VRzU_6vcVTsRca0uOIBQJXVaU/edit?gid=1969763406#gid=1969763406&quot;</span>
	<span class="n">Id</span><span class="o">=</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/d/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">gid</span><span class="o">=</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;?gid=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#gid=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;https://docs.google.com/spreadsheets/d/</span><span class="si">{</span><span class="n">Id</span><span class="si">}</span><span class="s2">/export?format=tsv&amp;id=</span><span class="si">{</span><span class="n">Id</span><span class="si">}</span><span class="s2">&amp;gid=</span><span class="si">{</span><span class="n">gid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
					 <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="despine">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.despine">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">despine</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Remove the top and right spines from plot(s).</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	fig : matplotlib figure, optional</span>
<span class="sd">		Figure to despine all axes of, defaults to the current figure.</span>
<span class="sd">	ax : matplotlib axes, optional</span>
<span class="sd">		Specific axes object to despine. Ignored if fig is provided.</span>
<span class="sd">	top, right, left, bottom : boolean, optional</span>
<span class="sd">		If True, remove that spine.</span>

<span class="sd">	Returns</span>
<span class="sd">	-------</span>
<span class="sd">	None</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">axes</span>
	<span class="k">elif</span> <span class="n">fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">axes</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span>
	<span class="k">elif</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="p">]</span>

	<span class="k">for</span> <span class="n">ax_i</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">]:</span>
			<span class="n">is_visible</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">side</span><span class="p">]</span>
			<span class="n">ax_i</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">side</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="n">is_visible</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">left</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">right</span><span class="p">:</span>  <span class="c1"># remove left, keep right</span>
			<span class="n">maj_on</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">tick1line</span><span class="o">.</span><span class="n">get_visible</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ax_i</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">majorTicks</span><span class="p">)</span>
			<span class="n">min_on</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">tick1line</span><span class="o">.</span><span class="n">get_visible</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ax_i</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">minorTicks</span><span class="p">)</span>
			<span class="n">ax_i</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ax_i</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">majorTicks</span><span class="p">:</span>
				<span class="n">t</span><span class="o">.</span><span class="n">tick2line</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="n">maj_on</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ax_i</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">minorTicks</span><span class="p">:</span>
				<span class="n">t</span><span class="o">.</span><span class="n">tick2line</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="n">min_on</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">bottom</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">top</span><span class="p">:</span>
			<span class="n">maj_on</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">tick1line</span><span class="o">.</span><span class="n">get_visible</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ax_i</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">majorTicks</span><span class="p">)</span>
			<span class="n">min_on</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">tick1line</span><span class="o">.</span><span class="n">get_visible</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ax_i</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">minorTicks</span><span class="p">)</span>
			<span class="n">ax_i</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ax_i</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">majorTicks</span><span class="p">:</span>
				<span class="n">t</span><span class="o">.</span><span class="n">tick2line</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="n">maj_on</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ax_i</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">minorTicks</span><span class="p">:</span>
				<span class="n">t</span><span class="o">.</span><span class="n">tick2line</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="n">min_on</span><span class="p">)</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_make_tiny_axis_label</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">arrow_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="c1"># This function assume coord is [0, 1].</span>
    <span class="c1"># clean ax axises</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">despine</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">_arrow_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mf">0.003</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">arrow_kws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_arrow_kws</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arrow_kws</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="mf">0.06</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="o">**</span><span class="n">_arrow_kws</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="mf">0.06</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">_arrow_kws</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="mf">0.06</span><span class="p">,</span>
        <span class="mf">0.03</span><span class="p">,</span>
        <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span>
        <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="n">fontsize</span><span class="p">,</span> <span class="s2">&quot;horizontalalignment&quot;</span><span class="p">:</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;verticalalignment&quot;</span><span class="p">:</span> <span class="s2">&quot;center&quot;</span><span class="p">},</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="mf">0.03</span><span class="p">,</span>
        <span class="mf">0.06</span><span class="p">,</span>
        <span class="n">y</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span>
        <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="n">fontsize</span><span class="p">,</span>
            <span class="s2">&quot;rotation&quot;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>
            <span class="s2">&quot;rotation_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;anchor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;horizontalalignment&quot;</span><span class="p">:</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="s2">&quot;verticalalignment&quot;</span><span class="p">:</span> <span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span>

<div class="viewcode-block" id="zoom_min_max">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.zoom_min_max">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">zoom_min_max</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Zoom min and max value.&quot;&quot;&quot;</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span>
    <span class="n">width_zoomed</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">scale</span>
    <span class="n">delta_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">width_zoomed</span> <span class="o">-</span> <span class="n">width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">vmin</span> <span class="o">-</span> <span class="n">delta_value</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">+</span> <span class="n">delta_value</span></div>


<div class="viewcode-block" id="zoom_ax">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.zoom_ax">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">zoom_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">zoom_scale</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Zoom ax on both x and y-axis.&quot;&quot;&quot;</span>
    <span class="n">on</span> <span class="o">=</span> <span class="n">on</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
    <span class="n">xlim_zoomed</span> <span class="o">=</span> <span class="n">zoom_min_max</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">scale</span><span class="o">=</span><span class="n">zoom_scale</span><span class="p">)</span>

    <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="n">ylim_zoomed</span> <span class="o">=</span> <span class="n">zoom_min_max</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">scale</span><span class="o">=</span><span class="n">zoom_scale</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">on</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">on</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim_zoomed</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">on</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="n">on</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim_zoomed</span><span class="p">)</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_extract_coords</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">coord_base</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
	<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
	<span class="kn">import</span><span class="w"> </span><span class="nn">anndata</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
		<span class="k">pass</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">x</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coord_base</span><span class="si">}</span><span class="s2">_0&quot;</span>
		<span class="n">y</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coord_base</span><span class="si">}</span><span class="s2">_1&quot;</span>

	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">):</span>
		<span class="n">adata</span> <span class="o">=</span> <span class="n">data</span>
		<span class="n">_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
			<span class="p">{</span>
				<span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;X_</span><span class="si">{</span><span class="n">coord_base</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span>
				<span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;X_</span><span class="si">{</span><span class="n">coord_base</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span>
			<span class="p">},</span>
			<span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">,</span>
		<span class="p">)</span>
	<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="n">data</span>
		<span class="k">if</span> <span class="n">coord_base</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;xr.Dataset do not contain </span><span class="si">{</span><span class="n">coord_base</span><span class="si">}</span><span class="s2"> dim&quot;</span><span class="p">)</span>
		<span class="n">data_var</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">coord_base</span><span class="p">)}</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
		<span class="n">_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
			<span class="p">{</span>
				<span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="p">[</span><span class="n">data_var</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">({</span><span class="n">coord_base</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coord_base</span><span class="si">}</span><span class="s2">_0&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">(),</span>
				<span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">ds</span><span class="p">[</span><span class="n">data_var</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">({</span><span class="n">coord_base</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coord_base</span><span class="si">}</span><span class="s2">_1&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">(),</span>
			<span class="p">}</span>
		<span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">y</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> or </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2"> not found in columns.&quot;</span><span class="p">)</span>
		<span class="n">_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]})</span>
	<span class="k">return</span> <span class="n">_data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_density_based_sample</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">coords</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">portion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Down sample data based on density, to prevent overplot in dense region and decrease plotting time.&quot;&quot;&quot;</span>
	<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalOutlierFactor</span>
	<span class="n">clf</span> <span class="o">=</span> <span class="n">LocalOutlierFactor</span><span class="p">(</span>
		<span class="n">n_neighbors</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
		<span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
		<span class="n">leaf_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
		<span class="n">metric</span><span class="o">=</span><span class="s2">&quot;minkowski&quot;</span><span class="p">,</span>
		<span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
		<span class="n">metric_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">contamination</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
	<span class="p">)</span>

	<span class="c1"># coords should already exist in data, get them by column names list</span>
	<span class="n">data_coords</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">coords</span><span class="p">]</span>
	<span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_coords</span><span class="p">)</span>
	<span class="c1"># original score is negative, the larger the denser</span>
	<span class="n">density_score</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">negative_outlier_factor_</span>
	<span class="n">delta</span> <span class="o">=</span> <span class="n">density_score</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">density_score</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
	<span class="c1"># density score to probability: the denser the less probability to be picked up</span>
	<span class="n">probability_score</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">density_score</span> <span class="o">-</span> <span class="n">density_score</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="n">delta</span>
	<span class="n">probability_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">probability_score</span><span class="p">)</span>
	<span class="n">probability_score</span> <span class="o">=</span> <span class="n">probability_score</span> <span class="o">/</span> <span class="n">probability_score</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

	<span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">pass</span>
	<span class="k">elif</span> <span class="n">portion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data_coords</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">portion</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either portion or size should be provided.&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
	<span class="n">selected_cell_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
		<span class="n">data_coords</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">probability_score</span>
	<span class="p">)</span>  <span class="c1"># choice data based on density weights</span>

	<span class="c1"># return the down sampled data</span>
	<span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">selected_cell_index</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_auto_size</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">n_dots</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Auto determine dot size based on ax size and n dots&quot;&quot;&quot;</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">dpi_scale_trans</span><span class="o">.</span><span class="n">inverted</span><span class="p">())</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">bbox</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mf">14.6</span>  <span class="c1"># 14.6 is a 5*5 fig I used to estimate</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">n_dots</span> <span class="o">/</span> <span class="n">scale</span>  <span class="c1"># larger figure means data look sparser</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">14</span> <span class="o">-</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1500</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">3000</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">8000</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">15000</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">30000</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">50000</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">80000</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">150000</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">0.6</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">300000</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">500000</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">0.4</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">800000</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2000000</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">3000000</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">0.07</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">4000000</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">5000000</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">0.03</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">0.02</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_take_data_series</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
	<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
	<span class="kn">import</span><span class="w"> </span><span class="nn">anndata</span>
	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)):</span>
		<span class="n">_value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
	<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">):</span>
		<span class="n">_value</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">_value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="k">return</span> <span class="n">_value</span>

<div class="viewcode-block" id="level_one_palette">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.level_one_palette">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">level_one_palette</span><span class="p">(</span><span class="n">name_list</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">):</span>
	<span class="n">name_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">name_list</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
	<span class="k">if</span> <span class="n">palette</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_set</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
			<span class="n">palette</span> <span class="o">=</span> <span class="s2">&quot;tab10&quot;</span>
		<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_set</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
			<span class="n">palette</span> <span class="o">=</span> <span class="s2">&quot;tab20&quot;</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">palette</span> <span class="o">=</span> <span class="s2">&quot;rainbow&quot;</span>

	<span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">order</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">name_set</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
			<span class="c1"># name set contains multiple dtype (e.g., str and np.NaN)</span>
			<span class="c1"># do not sort</span>
			<span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">name_set</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">order</span><span class="p">)</span> <span class="o">!=</span> <span class="n">name_set</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_set</span><span class="p">)):</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Order is not equal to set(name_list).&quot;</span><span class="p">)</span>

	<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
	<span class="n">colors</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">palette</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
	<span class="n">color_palette</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
		<span class="n">color_palette</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
	<span class="k">return</span> <span class="n">color_palette</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_calculate_luminance</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Calculate the relative luminance of a color according to W3C standards</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	color : matplotlib color or sequence of matplotlib colors</span>
<span class="sd">		Hex code, rgb-tuple, or html color name.</span>
<span class="sd">	Returns</span>
<span class="sd">	-------</span>
<span class="sd">	luminance : float(s) between 0 and 1</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">rgb</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">colorConverter</span><span class="o">.</span><span class="n">to_rgba_array</span><span class="p">(</span><span class="n">color</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
	<span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rgb</span> <span class="o">&lt;=</span> <span class="mf">0.03928</span><span class="p">,</span> <span class="n">rgb</span> <span class="o">/</span> <span class="mf">12.92</span><span class="p">,</span> <span class="p">((</span><span class="n">rgb</span> <span class="o">+</span> <span class="mf">0.055</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.055</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.4</span><span class="p">)</span>
	<span class="n">lum</span> <span class="o">=</span> <span class="n">rgb</span><span class="o">.</span><span class="n">dot</span><span class="p">([</span><span class="mf">0.2126</span><span class="p">,</span> <span class="mf">0.7152</span><span class="p">,</span> <span class="mf">0.0722</span><span class="p">])</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">lum</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
	<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">lum</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_text_anno_scatter</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">ax</span><span class="p">,</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">dodge_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">anno_col</span><span class="o">=</span><span class="s2">&quot;text_anno&quot;</span><span class="p">,</span>
    <span class="n">text_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">text_transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dodge_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">luminance</span><span class="o">=</span><span class="mf">0.48</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Add text annotation to a scatter plot.&quot;&quot;&quot;</span>
	<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
	<span class="c1"># prepare kws</span>
	<span class="n">text_kws</span><span class="o">=</span><span class="p">{}</span> <span class="k">if</span> <span class="n">text_kws</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">text_kws</span>
	<span class="n">text_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;fontsize&quot;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
	<span class="n">text_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;fontweight&quot;</span><span class="p">,</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
	<span class="n">text_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;ha&quot;</span><span class="p">,</span><span class="s2">&quot;center&quot;</span><span class="p">)</span> <span class="c1">#horizontalalignment</span>
	<span class="n">text_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;va&quot;</span><span class="p">,</span><span class="s2">&quot;center&quot;</span><span class="p">)</span> <span class="c1">#verticalalignment</span>
	<span class="n">text_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span><span class="s2">&quot;black&quot;</span><span class="p">)</span> <span class="c1">#c</span>
	<span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span><span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
								<span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
	<span class="n">text_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;bbox&quot;</span><span class="p">,</span><span class="n">bbox</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">bbox</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]:</span>
			<span class="n">text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">bbox</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
	<span class="c1"># plot each text</span>
	<span class="n">text_list</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">sub_df</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">anno_col</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">text_transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">text</span> <span class="o">=</span> <span class="n">text_transform</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;nan&quot;</span><span class="p">]:</span>
			<span class="k">continue</span>
		<span class="n">_x</span><span class="p">,</span> <span class="n">_y</span> <span class="o">=</span> <span class="n">sub_df</span><span class="p">[[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
		
		<span class="n">use_text_kws</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">text_kws</span><span class="p">)</span> <span class="c1">#text_kws.copy()</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">][</span><span class="s1">&#39;facecolor&#39;</span><span class="p">],</span><span class="nb">dict</span><span class="p">):</span>
			<span class="n">use_text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">][</span><span class="s1">&#39;facecolor&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">][</span><span class="s1">&#39;facecolor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_kws</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span><span class="nb">dict</span><span class="p">):</span>
			<span class="n">use_color</span><span class="o">=</span><span class="n">text_kws</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
			<span class="n">use_text_kws</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">use_color</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">luminance</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">use_text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">][</span><span class="s1">&#39;facecolor&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">lum</span> <span class="o">=</span> <span class="n">_calculate_luminance</span><span class="p">(</span><span class="n">use_text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">][</span><span class="s1">&#39;facecolor&#39;</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">lum</span> <span class="o">&gt;</span> <span class="n">luminance</span><span class="p">:</span>
				<span class="n">use_text_kws</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;black&#39;</span>
				<span class="n">use_text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">][</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;black&#39;</span>
		
		<span class="n">text</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
			<span class="n">_x</span><span class="p">,</span>
			<span class="n">_y</span><span class="p">,</span>
			<span class="n">text</span><span class="p">,</span>
			<span class="o">**</span><span class="n">use_text_kws</span>
		<span class="p">)</span>
		<span class="n">text_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">dodge_text</span><span class="p">:</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="kn">from</span><span class="w"> </span><span class="nn">adjustText</span><span class="w"> </span><span class="kn">import</span> <span class="n">adjust_text</span>

			<span class="n">_dodge_parms</span> <span class="o">=</span> <span class="p">{</span>
				<span class="s2">&quot;force_points&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
				<span class="s2">&quot;arrowprops&quot;</span><span class="p">:</span> <span class="p">{</span>
					<span class="s2">&quot;arrowstyle&quot;</span><span class="p">:</span> <span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span>
					<span class="s2">&quot;fc&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
					<span class="s2">&quot;ec&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
					<span class="s2">&quot;connectionstyle&quot;</span><span class="p">:</span> <span class="s2">&quot;angle,angleA=-90,angleB=180,rad=5&quot;</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="s2">&quot;autoalign&quot;</span><span class="p">:</span> <span class="s2">&quot;xy&quot;</span><span class="p">,</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="n">dodge_kws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">_dodge_parms</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dodge_kws</span><span class="p">)</span>
			<span class="n">adjust_text</span><span class="p">(</span><span class="n">text_list</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">_dodge_parms</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Install adjustText package to dodge text, see its github page for help&quot;</span><span class="p">)</span>
	<span class="k">return</span>

<div class="viewcode-block" id="tight_hue_range">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.tight_hue_range">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">tight_hue_range</span><span class="p">(</span><span class="n">hue_data</span><span class="p">,</span> <span class="n">portion</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;Automatic select a SMALLEST data range that covers [portion] of the data.&quot;&quot;&quot;</span>
	<span class="n">hue_data</span> <span class="o">=</span> <span class="n">hue_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">hue_data</span><span class="p">)]</span>
	<span class="n">hue_quantiles</span> <span class="o">=</span> <span class="n">hue_data</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">))</span>
	<span class="n">min_window_right</span> <span class="o">=</span> <span class="p">(</span>
		<span class="n">hue_quantiles</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">portion</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">i</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
	<span class="p">)</span>
	<span class="n">min_window_left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_window_right</span> <span class="o">-</span> <span class="n">portion</span><span class="p">)</span>
	<span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">hue_data</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="p">[</span><span class="n">min_window_left</span><span class="p">,</span> <span class="n">min_window_right</span><span class="p">]))</span>
	<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">vmin</span><span class="p">):</span>
		<span class="n">vmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">hue_data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmin</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">vmin</span> <span class="o">=</span> <span class="n">hue_data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">vmax</span><span class="p">):</span>
		<span class="n">vmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hue_data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">vmax</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">vmax</span> <span class="o">=</span> <span class="n">hue_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
	<span class="k">return</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span></div>


<div class="viewcode-block" id="density_contour">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.density_contour">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">density_contour</span><span class="p">(</span>
    <span class="n">ax</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">x</span><span class="p">,</span>
    <span class="n">y</span><span class="p">,</span>
    <span class="n">groupby</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">,</span>
    <span class="n">single_contour_pad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">palette</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
	<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalOutlierFactor</span>
	<span class="n">_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

	<span class="k">if</span> <span class="n">groupby</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;groupby&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;groupby&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">groupby</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;groupby&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;one group&quot;</span>

	<span class="n">_contour_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;linewidths&quot;</span><span class="p">:</span> <span class="n">linewidth</span><span class="p">,</span> <span class="s2">&quot;levels&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">single_contour_pad</span><span class="p">,),</span> <span class="s2">&quot;linestyles&quot;</span><span class="p">:</span> <span class="s2">&quot;dashed&quot;</span><span class="p">}</span>
	<span class="n">_lof_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;n_neighbors&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;novelty&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;contamination&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">}</span>

	<span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
	<span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
	<span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">zoom_min_max</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
	<span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">zoom_min_max</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>

	<span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">sub_data</span> <span class="ow">in</span> <span class="n">_data</span><span class="p">[[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;groupby&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;groupby&quot;</span><span class="p">):</span>
		<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="mi">500</span><span class="p">))</span>
		<span class="n">clf</span> <span class="o">=</span> <span class="n">LocalOutlierFactor</span><span class="p">(</span><span class="o">**</span><span class="n">_lof_kws</span><span class="p">)</span>
		<span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">sub_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
		<span class="n">z</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>
		<span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">palette</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">_color</span> <span class="o">=</span> <span class="n">c</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">_color</span> <span class="o">=</span> <span class="n">palette</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">palette</span> <span class="k">else</span> <span class="n">c</span>
		<span class="c1"># plot contour line(s)</span>
		<span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">_color</span><span class="p">,</span> <span class="o">**</span><span class="n">_contour_kws</span><span class="p">)</span>
	<span class="k">return</span></div>


<div class="viewcode-block" id="plot_color_dict_legend">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.plot_color_dict_legend">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_color_dict_legend</span><span class="p">(</span>
	<span class="n">D</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
	<span class="n">kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">luminance</span><span class="o">=</span><span class="mf">0.5</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	plot legned for color dict</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	D: a dict, key is categorical variable, values are colors.</span>
<span class="sd">	ax: axes to plot the legend.</span>
<span class="sd">	title: title of legend.</span>
<span class="sd">	color_text: whether to change the color of text based on the color in D.</span>
<span class="sd">	label_side: right of left.</span>
<span class="sd">	kws: kws passed to plt.legend.</span>

<span class="sd">	Returns</span>
<span class="sd">	-------</span>
<span class="sd">	ax.legend</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpatches</span>
	<span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
	<span class="n">lgd_kws</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">kws</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>  <span class="c1"># bbox_to_anchor=(x,-0.05)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;frameon&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;ncol&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">lgd_kws</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;upper left&quot;</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;borderpad&quot;</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">mm2inch</span> <span class="o">*</span> <span class="mi">72</span><span class="p">)</span>  <span class="c1"># 0.1mm</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;markerscale&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;handleheight&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># font size, units is points</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;handlelength&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># font size, units is points</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
		<span class="s2">&quot;borderaxespad&quot;</span><span class="p">,</span> <span class="mf">0.1</span>
	<span class="p">)</span>  <span class="c1"># The pad between the axes and legend border, in font-size units.</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
		<span class="s2">&quot;handletextpad&quot;</span><span class="p">,</span> <span class="mf">0.4</span>
	<span class="p">)</span>  <span class="c1"># The pad between the legend handle and text, in font-size units.</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
		<span class="s2">&quot;labelspacing&quot;</span><span class="p">,</span> <span class="mf">0.15</span>
	<span class="p">)</span>  <span class="c1"># gap height between two Patches,  0.05*mm2inch*72</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;columnspacing&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
	<span class="c1"># lgd_kws[&quot;bbox_transform&quot;] = ax.figure.transFigure</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;bbox_to_anchor&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;markerfirst&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
	<span class="n">l</span> <span class="o">=</span> <span class="p">[</span>
		<span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">D</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
	<span class="p">]</span>  <span class="c1"># kws:?mpatches.Patch; rasterized=True</span>
	<span class="n">ms</span> <span class="o">=</span> <span class="n">lgd_kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;markersize&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
	<span class="n">L</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="o">**</span><span class="n">lgd_kws</span><span class="p">)</span>
	<span class="n">L</span><span class="o">.</span><span class="n">_legend_box</span><span class="o">.</span><span class="n">align</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>
	<span class="n">L</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span><span class="o">.</span><span class="n">set_ha</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">color_text</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">L</span><span class="o">.</span><span class="n">get_texts</span><span class="p">():</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">lum</span> <span class="o">=</span> <span class="n">_calculate_luminance</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="n">text</span><span class="o">.</span><span class="n">get_text</span><span class="p">()])</span>
				<span class="k">if</span> <span class="n">luminance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">text_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">text_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span> <span class="k">if</span> <span class="n">lum</span> <span class="o">&gt;</span> <span class="n">luminance</span> <span class="k">else</span> <span class="n">D</span><span class="p">[</span><span class="n">text</span><span class="o">.</span><span class="n">get_text</span><span class="p">()]</span>
				<span class="n">text</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">text_color</span><span class="p">)</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="k">pass</span>
	<span class="c1"># ax.add_artist(L)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">L</span></div>


<div class="viewcode-block" id="plot_marker_legend">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.plot_marker_legend">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_marker_legend</span><span class="p">(</span>
	<span class="n">color_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
	<span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">luminance</span><span class="o">=</span><span class="mf">0.5</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	plot legned for different marker</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	D: a dict, key is categorical variable, values are marker.</span>
<span class="sd">	ax: axes to plot the legend.</span>
<span class="sd">	title: title of legend.</span>
<span class="sd">	color_text: whether to change the color of text based on the color in D.</span>
<span class="sd">	label_side: right of left.</span>
<span class="sd">	kws: kws passed to plt.legend.</span>

<span class="sd">	Returns</span>
<span class="sd">	-------</span>
<span class="sd">	ax.legend</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

	<span class="n">lgd_kws</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">kws</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>  <span class="c1"># bbox_to_anchor=(x,-0.05)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;frameon&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;ncol&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">lgd_kws</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;upper left&quot;</span>
	<span class="c1"># lgd_kws[&quot;bbox_transform&quot;] = ax.figure.transFigure</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;borderpad&quot;</span><span class="p">,</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">mm2inch</span> <span class="o">*</span> <span class="mi">72</span><span class="p">)</span>  <span class="c1"># 0.1mm</span>
	<span class="c1"># lgd_kws.setdefault(&quot;markerscale&quot;, 1)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;handleheight&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># font size, units is points</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;handlelength&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># font size, units is points</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
		<span class="s2">&quot;borderaxespad&quot;</span><span class="p">,</span> <span class="mf">0.1</span>
	<span class="p">)</span>  <span class="c1"># The pad between the axes and legend border, in font-size units.</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
		<span class="s2">&quot;handletextpad&quot;</span><span class="p">,</span> <span class="mf">0.4</span> <span class="c1">#0.2 * mm2inch * 72</span>
	<span class="p">)</span>  <span class="c1"># The pad between the legend handle and text, in font-size units.</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
		<span class="s2">&quot;labelspacing&quot;</span><span class="p">,</span> <span class="mf">0.15</span>
	<span class="p">)</span>  <span class="c1"># gap height between two Patches,  0.05*mm2inch*72</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;columnspacing&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;bbox_to_anchor&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;markerfirst&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

	<span class="n">ms</span> <span class="o">=</span> <span class="n">lgd_kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;markersize&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
	<span class="n">L</span> <span class="o">=</span> <span class="p">[</span>
		<span class="n">Line2D</span><span class="p">(</span>
			<span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
			<span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
			<span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
			<span class="n">markersize</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span>
			<span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">color</span> <span class="ow">in</span> <span class="n">color_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
	<span class="p">]</span>
	<span class="n">L</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">L</span><span class="p">,</span> <span class="o">**</span><span class="n">lgd_kws</span><span class="p">)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
	<span class="n">L</span><span class="o">.</span><span class="n">_legend_box</span><span class="o">.</span><span class="n">align</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>
	<span class="n">L</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span><span class="o">.</span><span class="n">set_ha</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">color_text</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">L</span><span class="o">.</span><span class="n">get_texts</span><span class="p">():</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">lum</span> <span class="o">=</span> <span class="n">_calculate_luminance</span><span class="p">(</span><span class="n">color_dict</span><span class="p">[</span><span class="n">text</span><span class="o">.</span><span class="n">get_text</span><span class="p">()])</span>
				<span class="k">if</span> <span class="n">luminance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">text_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">text_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span> <span class="k">if</span> <span class="n">lum</span> <span class="o">&gt;</span> <span class="n">luminance</span> <span class="k">else</span> <span class="n">color_dict</span><span class="p">[</span><span class="n">text</span><span class="o">.</span><span class="n">get_text</span><span class="p">()]</span>
				<span class="n">text</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">text_color</span><span class="p">)</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="k">pass</span>
	<span class="c1"># ax.add_artist(lgd)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">L</span></div>


<span class="c1"># Custom handler for legend: circle text as marker + label</span>
<div class="viewcode-block" id="TextWithCircleHandler">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.TextWithCircleHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TextWithCircleHandler</span><span class="p">(</span><span class="n">HandlerBase</span><span class="p">):</span>
	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">marker_text</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">label_text</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
			  <span class="n">text_kws</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="n">HandlerBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">marker_text</span> <span class="o">=</span> <span class="n">marker_text</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">text_kws</span><span class="o">=</span><span class="n">text_kws</span>

<div class="viewcode-block" id="TextWithCircleHandler.create_artists">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.TextWithCircleHandler.create_artists">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">create_artists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">orig_handle</span><span class="p">,</span>
						<span class="n">xdescent</span><span class="p">,</span> <span class="n">ydescent</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">trans</span><span class="p">):</span>
		<span class="c1"># Marker (number with circle)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">text_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;fontsize&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="p">)</span>
		<span class="c1"># print(self.text_kws)</span>
		<span class="n">shift</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_kws</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.65</span> <span class="o">/</span> <span class="mi">72</span> <span class="o">/</span> <span class="n">mm2inch</span>
		<span class="n">circ_text</span> <span class="o">=</span> <span class="n">Text</span><span class="p">(</span>
			<span class="n">xdescent</span> <span class="o">+</span> <span class="n">legend</span><span class="o">.</span><span class="n">borderaxespad</span> <span class="o">+</span> <span class="n">shift</span><span class="p">,</span>  <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">marker_text</span><span class="p">,</span> 
			<span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">text_kws</span>
		<span class="p">)</span>
		<span class="k">return</span> <span class="p">[</span><span class="n">circ_text</span><span class="p">]</span></div>
</div>

	
<div class="viewcode-block" id="plot_text_legend">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.plot_text_legend">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_text_legend</span><span class="p">(</span><span class="n">color_dict</span><span class="p">,</span> <span class="n">code2label</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
					 <span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;Circle&#39;</span><span class="p">,</span><span class="n">marker_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">legend_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">marker_fontsize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
					 <span class="n">text_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">luminance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
	<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
	<span class="c1"># print(color_dict)</span>
	<span class="n">lgd_kws</span> <span class="o">=</span> <span class="n">legend_kws</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">legend_kws</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>  <span class="c1"># bbox_to_anchor=(x,-0.05)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;frameon&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;ncol&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">lgd_kws</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;upper left&quot;</span>
	<span class="c1"># lgd_kws[&quot;bbox_transform&quot;] = ax.figure.transFigure</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;borderpad&quot;</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">mm2inch</span> <span class="o">*</span> <span class="mi">72</span><span class="p">)</span>  <span class="c1"># 0.1mm</span>
	<span class="c1"># lgd_kws.setdefault(&quot;markerscale&quot;, 1)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;handleheight&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># font size, units is points</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;handlelength&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># font size, units is points</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
		<span class="s2">&quot;borderaxespad&quot;</span><span class="p">,</span> <span class="mf">0.5</span>
	<span class="p">)</span>  <span class="c1"># The pad between the axes and legend border, in font-size units.</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
		<span class="s2">&quot;handletextpad&quot;</span><span class="p">,</span> <span class="mf">0.4</span>
	<span class="p">)</span>  <span class="c1"># The pad between the legend handle and text, in font-size units.</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
		<span class="s2">&quot;labelspacing&quot;</span><span class="p">,</span> <span class="mf">0.2</span>
	<span class="p">)</span>  <span class="c1"># gap height between two row of legend,  0.05*mm2inch*72</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;columnspacing&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;bbox_to_anchor&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;markerfirst&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
	<span class="n">ms</span> <span class="o">=</span> <span class="n">lgd_kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;markersize&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

	<span class="c1"># text_kws</span>
	<span class="k">if</span> <span class="n">text_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">text_kws</span><span class="o">=</span><span class="p">{}</span>
	<span class="n">default_marker_text_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
		<span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">boxstyle</span><span class="si">}</span><span class="s2">,pad=</span><span class="si">{</span><span class="n">marker_pad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="c1">#Square, Circle, Round</span>
			<span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
			<span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">),</span>
		<span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
		<span class="n">fontsize</span><span class="o">=</span><span class="n">marker_fontsize</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">default_marker_text_kws</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;bbox&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text_kws</span><span class="p">:</span>
				<span class="n">text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">default_marker_text_kws</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="n">default_marker_text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="k">if</span> <span class="n">k1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]:</span>
						<span class="n">text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span><span class="n">default_marker_text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">][</span><span class="n">k1</span><span class="p">])</span>
		<span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text_kws</span><span class="p">:</span>
			<span class="n">text_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">default_marker_text_kws</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
	
	<span class="c1"># Create handles and handlers</span>
	<span class="n">handles</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">handler_map</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">code2label</span><span class="o">.</span><span class="n">keys</span><span class="p">()]):</span>
		<span class="n">label</span><span class="o">=</span><span class="n">code2label</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
		<span class="n">code_text</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">linestyle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
				  <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
		<span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
		<span class="n">color</span><span class="o">=</span><span class="n">color_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
		<span class="n">text_kws1</span><span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">text_kws</span><span class="p">)</span>
		<span class="n">text_kws1</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">][</span><span class="s1">&#39;facecolor&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">color</span>
		<span class="n">lum</span> <span class="o">=</span> <span class="n">_calculate_luminance</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">lum</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span> <span class="c1"># for black-like color, use white marker text</span>
			<span class="n">text_kws1</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;white&#39;</span>
		<span class="c1"># print(bbox)</span>
		<span class="n">handler_map</span><span class="p">[</span><span class="n">handle</span><span class="p">]</span> <span class="o">=</span> <span class="n">TextWithCircleHandler</span><span class="p">(</span>
			<span class="n">marker_text</span><span class="o">=</span><span class="n">code_text</span><span class="p">,</span> <span class="n">label_text</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
			<span class="n">text_kws</span><span class="o">=</span><span class="n">text_kws1</span><span class="p">,</span>
			<span class="p">)</span>

	<span class="c1"># Draw custom legend</span>
	<span class="n">L</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span> <span class="n">handler_map</span><span class="o">=</span><span class="n">handler_map</span><span class="p">,</span> 
			 <span class="o">**</span><span class="n">lgd_kws</span><span class="p">)</span>
	<span class="n">L</span><span class="o">.</span><span class="n">_legend_box</span><span class="o">.</span><span class="n">align</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>
	<span class="n">L</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span><span class="o">.</span><span class="n">set_ha</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">color_text</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">L</span><span class="o">.</span><span class="n">get_texts</span><span class="p">():</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">lum</span> <span class="o">=</span> <span class="n">_calculate_luminance</span><span class="p">(</span><span class="n">color_dict</span><span class="p">[</span><span class="n">text</span><span class="o">.</span><span class="n">get_text</span><span class="p">()])</span>
				<span class="k">if</span> <span class="n">luminance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">text_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">text_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span> <span class="k">if</span> <span class="n">lum</span> <span class="o">&gt;</span> <span class="n">luminance</span> <span class="k">else</span> <span class="n">color_dict</span><span class="p">[</span><span class="n">text</span><span class="o">.</span><span class="n">get_text</span><span class="p">()]</span>
				<span class="n">text</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">text_color</span><span class="p">)</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="k">pass</span></div>

	<span class="c1"># ax.add_artist(lgd)</span>
	<span class="c1"># ax.grid(False)</span>

<div class="viewcode-block" id="plot_cmap_legend">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.plot_cmap_legend">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_cmap_legend</span><span class="p">(</span>
	<span class="n">cax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;turbo&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">ticklabel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Plot legend for cmap.</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	cax : Axes into which the colorbar will be drawn.</span>
<span class="sd">	ax :  axes to anchor.</span>
<span class="sd">	cmap : turbo, hsv, Set1, Dark2, Paired, Accent,tab20,exp1,exp2,meth1,meth2</span>
<span class="sd">	label : title for legend.</span>
<span class="sd">	kws : dict</span>
<span class="sd">		kws passed to plt.colorbar (matplotlib.figure.Figure.colorbar).</span>

<span class="sd">	Returns</span>
<span class="sd">	-------</span>
<span class="sd">	cbar: axes of legend</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">label</span>
	<span class="n">cbar_kws</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">kws</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kws</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="n">cbar_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
	<span class="c1"># cbar_kws.setdefault(&quot;aspect&quot;,3)</span>
	<span class="n">cbar_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;orientation&quot;</span><span class="p">,</span> <span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
	<span class="c1"># cbar_kws.setdefault(&quot;use_gridspec&quot;, True)</span>
	<span class="c1"># cbar_kws.setdefault(&quot;location&quot;, &quot;bottom&quot;)</span>
	<span class="n">cbar_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;fraction&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">cbar_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;shrink&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">cbar_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;pad&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">cbar_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;extend&quot;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">)</span>
	<span class="n">cbar_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;extendfrac&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
	<span class="c1"># print(cbar_kws,kws)</span>
	<span class="c1"># print(type(cax))</span>
	<span class="n">vmax</span> <span class="o">=</span> <span class="n">cbar_kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;vmax&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">vmin</span> <span class="o">=</span> <span class="n">cbar_kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;vmin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="c1"># print(vmin,vmax,&#39;vmax,vmin&#39;)</span>
	<span class="n">cax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">])</span>
	<span class="c1"># print(cax.get_ylim())</span>
	<span class="n">vcenter</span><span class="o">=</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">+</span> <span class="n">vmin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
	<span class="n">center</span><span class="o">=</span><span class="n">cbar_kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;center&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">center</span><span class="o">=</span><span class="n">vcenter</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span>
			<span class="n">norm</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span>
		<span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span>
			<span class="n">norm</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">TwoSlopeNorm</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span>
		<span class="p">)</span>
	<span class="n">cbar_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;ticks&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">vmin</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">vmax</span><span class="p">])</span>
	<span class="n">cax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
	<span class="n">cax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
	<span class="n">cbar</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="o">**</span><span class="n">cbar_kws</span><span class="p">)</span>  <span class="c1"># use_gridspec=True</span>
	<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">ticklabel_size</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ticklabel_size</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span> <span class="c1"># size is for ticks, labelsize is for the number on ticks (ticklabels)</span>
	<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">labelsize</span><span class="p">)</span> <span class="c1"># colorbar title fontsize</span>
	<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">cbar</span></div>


<div class="viewcode-block" id="normalize_mc_by_cell">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.normalize_mc_by_cell">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">normalize_mc_by_cell</span><span class="p">(</span>
		<span class="n">use_adata</span><span class="p">,</span><span class="n">normalize_per_cell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
		<span class="n">clip_norm_value</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">hypo_score</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
	<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">issparse</span>
	<span class="n">normalized_flag</span> <span class="o">=</span> <span class="n">use_adata</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;normalize_per_cell&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">normalize_per_cell</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">normalized_flag</span><span class="p">:</span>  <span class="c1"># divide frac by prior mean (determined by alpha and beta) for each cell</span>
		<span class="c1"># get normalized X</span>
		<span class="n">cols</span> <span class="o">=</span> <span class="n">use_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
		<span class="k">if</span> <span class="s1">&#39;prior_mean&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Normalizing cell level fraction by alpha and beta (prior_mean)&quot;</span><span class="p">)</span>
			<span class="n">na_sum</span> <span class="o">=</span> <span class="n">use_adata</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">na_sum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">D</span> <span class="o">=</span> <span class="n">use_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">prior_mean</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">hypo_score</span><span class="p">:</span>
					<span class="n">use_adata</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">use_adata</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">])</span> <span class="o">/</span> <span class="n">D</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
				<span class="k">else</span><span class="p">:</span> <span class="c1"># hypo score, the larger the value, the more hypomethylated</span>
					<span class="n">use_adata</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">use_adata</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">D</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">hypo_score</span><span class="p">:</span> <span class="c1"># the smaller the value, the lower of the methylation fraction</span>
					<span class="n">use_adata</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">use_adata</span><span class="o">.</span><span class="n">X</span> <span class="o">/</span> <span class="n">use_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">prior_mean</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># range = [0,1,10]</span>
				<span class="k">else</span><span class="p">:</span> <span class="c1"># hypo-score</span>
					<span class="n">use_adata</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">use_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">prior_mean</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">/</span> <span class="n">use_adata</span><span class="o">.</span><span class="n">X</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">clip_norm_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">issparse</span><span class="p">(</span><span class="n">use_adata</span><span class="o">.</span><span class="n">X</span><span class="p">):</span>
					<span class="n">X</span><span class="o">=</span><span class="n">use_adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">X</span><span class="o">=</span><span class="n">use_adata</span><span class="o">.</span><span class="n">X</span>
				<span class="n">use_adata</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">clip_norm_value</span><span class="p">)</span>
			<span class="n">use_adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;normalize_per_cell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&#39;prior_mean&#39; not found in obs&quot;</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">normalize_per_cell</span> <span class="ow">and</span> <span class="n">normalized_flag</span><span class="p">:</span>
		<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Input adata is already normalized, skip normalize_per_cell !&quot;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">pass</span>
	<span class="k">return</span> <span class="n">use_adata</span></div>


<div class="viewcode-block" id="parse_gtf">
<a class="viewcode-back" href="../../adataviz.utils.html#adataviz.utils.parse_gtf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_gtf</span><span class="p">(</span><span class="n">gtf</span><span class="o">=</span><span class="s2">&quot;gencode.v43.annotation.gtf&quot;</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">gtf</span><span class="p">),</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span>
                    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chrom&#39;</span><span class="p">,</span><span class="s1">&#39;record_type&#39;</span><span class="p">,</span><span class="s1">&#39;beg&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;information&#39;</span><span class="p">])</span>
    <span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gene_id&#39;</span><span class="p">,</span><span class="s1">&#39;gene_type&#39;</span><span class="p">,</span><span class="s1">&#39;gene_name&#39;</span><span class="p">]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_info</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">D</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
            <span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">D</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">D</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;info_dict&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">information</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_info</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">info_dict</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;chrom&#39;</span><span class="p">,</span><span class="s1">&#39;beg&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">,</span><span class="s1">&#39;gene_name&#39;</span><span class="p">,</span><span class="s1">&#39;gene_id&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;gene_type&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span> <span class="c1"># &#39;chrom&#39;,&#39;start&#39;,&#39;end&#39;,&#39;gene_symbol&#39;,&#39;strand&#39;,&#39;gene_type&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">outfile</span><span class="p">),</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2026, Wubin Ding, Amit Klein
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../_static/documentation_options.js?v=8a448e45"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../../_static/js/rtd_search_config.js"></script>
    <script src="../../_static/js/rtd_sphinx_search.min.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/plotly_scroll.js?v=93e7370e"></script>
    </body>
</html>