<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html"><link rel="search" title="Search" href="../../search.html">

    <!-- Generated with Sphinx 8.1.3 and Furo 2025.12.19 -->
        <title>adataviz.plotting - adataviz documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/rtd_sphinx_search.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=3c555474" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>

<div class="announcement">
  <aside class="announcement-content">
     <em>Documentation website</em> is online! 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">adataviz  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <span class="sidebar-brand-text">adataviz  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../plot.html">Plotting</a><input aria-label="Toggle navigation of Plotting" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/plot.html">Plot embedding (umap or tsne)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/plot.html#Plot-dot-heatmap">Plot dot heatmap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/plot.html#Plot-boxplot">Plot boxplot</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../modules.html">adataviz</a><input aria-label="Toggle navigation of adataviz" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../adataviz.html">adataviz package</a><input aria-label="Toggle navigation of adataviz package" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adataviz.plotting.html">adataviz.plotting module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adataviz.tools.html">adataviz.tools module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adataviz.utils.html">adataviz.utils module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../setup.html">setup module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../citation.html">Citation</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for adataviz.plotting</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">re</span><span class="w"> </span><span class="kn">import</span> <span class="n">L</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">anndata</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scanpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pylab</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">Normalize</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
	<span class="n">_make_tiny_axis_label</span><span class="p">,</span> <span class="n">despine</span><span class="p">,</span>
	<span class="n">zoom_ax</span><span class="p">,</span> <span class="n">_extract_coords</span><span class="p">,</span>
	<span class="n">_density_based_sample</span><span class="p">,</span><span class="n">_auto_size</span><span class="p">,</span>
	<span class="n">_take_data_series</span><span class="p">,</span> <span class="n">level_one_palette</span><span class="p">,</span> 
	<span class="n">tight_hue_range</span><span class="p">,</span><span class="n">_text_anno_scatter</span><span class="p">,</span>
	<span class="n">density_contour</span><span class="p">,</span><span class="n">plot_color_dict_legend</span><span class="p">,</span>
	<span class="n">plot_marker_legend</span><span class="p">,</span><span class="n">plot_text_legend</span><span class="p">,</span><span class="n">plot_cmap_legend</span><span class="p">,</span>
	<span class="n">normalize_mc_by_cell</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_adata</span><span class="p">,</span><span class="n">load_obs</span><span class="p">,</span><span class="n">load_color_palette</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.io</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">loguru</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span> <span class="k">as</span> <span class="n">logger</span>
<span class="c1"># logger.add(sys.stderr, level=&quot;DEBUG&quot;)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="use_scientific_style">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.use_scientific_style">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">use_scientific_style</span><span class="p">():</span>
	<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pylab</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
		<span class="s1">&#39;font.family&#39;</span><span class="p">:</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">,</span>
		<span class="s1">&#39;font.sans-serif&#39;</span><span class="p">:</span> <span class="s1">&#39;Arial&#39;</span><span class="p">,</span>
		<span class="s1">&#39;font.family&#39;</span><span class="p">:</span> <span class="s1">&#39;Arial&#39;</span><span class="p">,</span>

		<span class="c1"># Base font size (set so text is ~7–8 pt at final print size)</span>
		<span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>                  <span class="c1"># main text (labels, ticks, legend)</span>
		<span class="s1">&#39;axes.labelsize&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>             <span class="c1"># axis labels (x/y)</span>
		<span class="s1">&#39;axes.titlesize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>            <span class="c1"># panel titles / figure titles</span>
		<span class="s1">&#39;figure.titlesize&#39;</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span>
		<span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>            <span class="c1"># x-tick labels</span>
		<span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>            <span class="c1"># y-tick labels</span>
		<span class="s1">&#39;legend.fontsize&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>            <span class="c1"># legend text</span>
		<span class="s1">&#39;legend.title_fontsize&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>      <span class="c1"># legend title (if used)</span>

		<span class="c1"># Lines and elements for clarity</span>
		<span class="s1">&#39;lines.linewidth&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>          <span class="c1"># data lines</span>
		<span class="s1">&#39;axes.linewidth&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>           <span class="c1"># axis spines</span>
		<span class="s1">&#39;xtick.major.width&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
		<span class="s1">&#39;ytick.major.width&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
		<span class="s1">&#39;xtick.major.size&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
		<span class="s1">&#39;ytick.major.size&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>

		<span class="c1"># General figure appearance</span>
		<span class="s1">&#39;figure.dpi&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>               <span class="c1"># high resolution for export</span>
		<span class="s1">&#39;savefig.dpi&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>              <span class="c1"># when using plt.savefig()</span>
		<span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">6.5</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">),</span>    <span class="c1"># example starting size (adjust to your needs; e.g., ~17 cm wide for full page)</span>
		<span class="s1">&#39;figure.constrained_layout.use&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
		<span class="s1">&#39;savefig.transparent&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
		<span class="s1">&#39;savefig.bbox&#39;</span><span class="p">:</span> <span class="s1">&#39;tight&#39;</span><span class="p">,</span>
		<span class="s1">&#39;pdf.fonttype&#39;</span><span class="p">:</span><span class="mi">42</span><span class="p">,</span>
		<span class="s1">&#39;ps.fonttype&#39;</span><span class="p">:</span><span class="mi">42</span><span class="p">,</span>
	<span class="p">})</span></div>

	<span class="c1"># plt.rcParams.keys()</span>

<span class="c1"># def get_colors(adata,variable=None,palette_path=None):</span>
<span class="c1"># 	if not palette_path is None:</span>
<span class="c1"># 		try:</span>
<span class="c1"># 			colors=pd.read_excel(palette_path,sheet_name=variable,index_col=0).Hex.to_dict()</span>
<span class="c1"># 		except:</span>
<span class="c1"># 			return None</span>
<span class="c1"># 	else:</span>
<span class="c1"># 		if adata is None:</span>
<span class="c1"># 			return None</span>
<span class="c1"># 		if isinstance(adata,str):</span>
<span class="c1"># 			adata=anndata.read_h5ad(adata,backed=&#39;r&#39;)</span>
<span class="c1"># 		if f&#39;{variable}_colors&#39; not in adata.uns:</span>
<span class="c1"># 			colors={cluster:color for cluster,color in zip(adata.obs[variable].cat.categories.tolist(),adata.uns[f&#39;{variable}_colors&#39;])}</span>
<span class="c1"># 		else:</span>
<span class="c1"># 			colors=None</span>
<span class="c1"># 	color_discrete_map=colors</span>
<span class="c1"># 	return color_discrete_map</span>

<div class="viewcode-block" id="interactive_embedding">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.interactive_embedding">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">interactive_embedding</span><span class="p">(</span>
		<span class="n">adata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">variable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">gene</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">coord</span><span class="o">=</span><span class="s2">&quot;umap&quot;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="s1">&#39;p1&#39;</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="s1">&#39;p99&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">palette_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">downsample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">target_fill</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
		<span class="n">normalize_per_cell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">clip_norm_value</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
		<span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;notebook&quot;</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Plot interactive embedding plot with plotly for a given AnnData object or path of .h5ad.</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	adata : _type_</span>
<span class="sd">		_description_</span>
<span class="sd">	obs : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	variable : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	gene : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	coord : str, optional</span>
<span class="sd">		_description_, by default &quot;umap&quot;</span>
<span class="sd">	vmin : str, optional</span>
<span class="sd">		_description_, by default &#39;p1&#39;</span>
<span class="sd">	vmax : str, optional</span>
<span class="sd">		_description_, by default &#39;p99&#39;</span>
<span class="sd">	cmap : str, optional</span>
<span class="sd">		_description_, by default &#39;jet&#39;</span>
<span class="sd">	title : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	width : int, optional</span>
<span class="sd">		_description_, by default 1000</span>
<span class="sd">	height : int, optional</span>
<span class="sd">		_description_, by default 800</span>
<span class="sd">	colors : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	palette_path : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	size : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	target_fill : float, optional</span>
<span class="sd">		_description_, by default 0.05</span>
<span class="sd">	show : bool, optional</span>
<span class="sd">		_description_, by default True</span>
<span class="sd">	renderer : str, optional</span>
<span class="sd">		_description_, by default &quot;notebook&quot;</span>
<span class="sd">		Available renderers:</span>
<span class="sd">        [&#39;plotly_mimetype&#39;, &#39;jupyterlab&#39;, &#39;nteract&#39;, &#39;vscode&#39;,</span>
<span class="sd">         &#39;notebook&#39;, &#39;notebook_connected&#39;, &#39;kaggle&#39;, &#39;azure&#39;, &#39;colab&#39;,</span>
<span class="sd">         &#39;cocalc&#39;, &#39;databricks&#39;, &#39;json&#39;, &#39;png&#39;, &#39;jpeg&#39;, &#39;jpg&#39;, &#39;svg&#39;,</span>
<span class="sd">         &#39;pdf&#39;, &#39;browser&#39;, &#39;firefox&#39;, &#39;chrome&#39;, &#39;chromium&#39;, &#39;iframe&#39;,</span>
<span class="sd">         &#39;iframe_connected&#39;, &#39;sphinx_gallery&#39;, &#39;sphinx_gallery_png&#39;]</span>

<span class="sd">	Returns</span>
<span class="sd">	-------</span>
<span class="sd">	_type_</span>
<span class="sd">		_description_</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">renderer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">pio</span><span class="o">.</span><span class="n">renderers</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">renderer</span>
	<span class="n">use_col</span><span class="o">=</span><span class="n">gene</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">gene</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">variable</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">gene</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">assert</span> <span class="ow">not</span> <span class="n">adata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;`gene` provided, `adata` must be provided too.&quot;</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">adata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">adata</span><span class="o">=</span><span class="n">load_adata</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
	<span class="n">use_adata</span><span class="o">=</span><span class="kc">None</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">gene</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># adata is not None</span>
		<span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">isbacked</span><span class="p">:</span> <span class="c1"># type: ignore</span>
			<span class="n">use_adata</span><span class="o">=</span><span class="n">adata</span><span class="p">[:,</span><span class="n">gene</span><span class="p">]</span><span class="o">.</span><span class="n">to_memory</span><span class="p">()</span> <span class="c1"># type: ignore</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">use_adata</span><span class="o">=</span><span class="n">adata</span><span class="p">[:,</span><span class="n">gene</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># type: ignore</span>
		<span class="k">if</span> <span class="n">normalize_per_cell</span><span class="p">:</span>
			<span class="n">use_adata</span> <span class="o">=</span> <span class="n">normalize_mc_by_cell</span><span class="p">(</span>
				<span class="n">use_adata</span><span class="o">=</span><span class="n">use_adata</span><span class="p">,</span> <span class="n">normalize_per_cell</span><span class="o">=</span><span class="n">normalize_per_cell</span><span class="p">,</span>
				<span class="n">clip_norm_value</span><span class="o">=</span><span class="n">clip_norm_value</span><span class="p">,</span><span class="n">hypo_score</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">adata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">use_adata</span><span class="o">=</span><span class="n">adata</span> <span class="c1"># backed</span>
	<span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">use_adata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either `adata` or `obs` must be provided.&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">obs</span><span class="o">=</span><span class="n">use_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># type: ignore</span>
	<span class="k">else</span><span class="p">:</span> <span class="c1"># obs not none</span>
		<span class="n">obs</span><span class="o">=</span><span class="n">load_obs</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">use_adata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">overlap_idx</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">use_adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">)</span>
			<span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">overlap_idx</span><span class="p">]</span>
			<span class="n">use_adata</span><span class="o">=</span><span class="n">use_adata</span><span class="p">[</span><span class="n">overlap_idx</span><span class="p">,:]</span> <span class="c1"># type: ignore</span>

	<span class="k">if</span> <span class="ow">not</span> <span class="n">gene</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">obs</span><span class="p">[</span><span class="n">gene</span><span class="p">]</span><span class="o">=</span><span class="n">use_adata</span><span class="o">.</span><span class="n">to_df</span><span class="p">()[</span><span class="n">gene</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="c1"># type: ignore</span>
	<span class="n">cols</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">_0&#39;</span> <span class="ow">in</span> <span class="n">cols</span> <span class="ow">or</span> <span class="ow">not</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">_1&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
		<span class="k">assert</span> <span class="sa">f</span><span class="s1">&#39;X_</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">use_adata</span><span class="o">.</span><span class="n">obsm</span> <span class="c1"># type: ignore</span>
		<span class="c1"># print(use_adata.obsm[f&#39;X_{coord}&#39;])</span>
		<span class="n">obs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">use_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;X_</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="c1"># type: ignore</span>
		<span class="n">obs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">use_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;X_</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="c1"># type: ignore</span>
		<span class="c1"># print(obs.head())</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">adata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">adata</span><span class="o">.</span><span class="n">isbacked</span><span class="p">:</span> <span class="c1"># type: ignore</span>
		<span class="n">adata</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># type: ignore</span>
	<span class="c1"># downsample obs for large dataset</span>
	<span class="n">n_points</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">downsample</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_points</span> <span class="o">&gt;</span> <span class="n">downsample</span><span class="p">:</span>
		<span class="n">sample_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_points</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">downsample</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># numbers</span>
		<span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>

	<span class="k">if</span> <span class="ow">not</span> <span class="n">obs</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">use_col</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">,</span><span class="s1">&#39;category&#39;</span><span class="p">]:</span>
		<span class="n">vmin_quantile</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">vmin</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">vmax_quantile</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">vmax</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
		<span class="c1"># print(vmin_quantile,vmax_quantile,obs[use_col],obs.dtypes[use_col])</span>
		<span class="n">range_color</span><span class="o">=</span><span class="p">[</span><span class="n">obs</span><span class="p">[</span><span class="n">use_col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">vmin_quantile</span><span class="p">),</span> <span class="n">obs</span><span class="p">[</span><span class="n">use_col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">vmax_quantile</span><span class="p">)]</span>
		<span class="n">color_discrete_map</span><span class="o">=</span><span class="kc">None</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="c1"># color_discrete_map=get_colors(use_adata,use_col,palette_path=palette_path)</span>
			<span class="n">color_discrete_map</span><span class="o">=</span><span class="n">load_color_palette</span><span class="p">(</span><span class="n">palette_path</span><span class="o">=</span><span class="n">palette_path</span><span class="p">,</span><span class="n">adata</span><span class="o">=</span><span class="n">use_adata</span><span class="p">,</span><span class="n">groups</span><span class="o">=</span><span class="n">use_col</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">color_discrete_map</span><span class="o">=</span><span class="n">colors</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">color_discrete_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">keys</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">color_discrete_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="c1"># type: ignore</span>
			<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obs</span><span class="p">[</span><span class="n">use_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
					<span class="k">del</span> <span class="n">color_discrete_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="c1"># type: ignore</span>
		<span class="n">range_color</span><span class="o">=</span><span class="kc">None</span>
	<span class="n">keep_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">]</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">variable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">keep_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">gene</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">keep_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span>
	<span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="s2">&quot;cell&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">keep_cols</span><span class="p">]</span>
	<span class="c1"># Create Plotly interactive scatter plot</span>
	<span class="n">hover_data</span><span class="o">=</span><span class="p">{</span>         <span class="c1"># Fields to show on hover</span>
			<span class="s2">&quot;cell&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>    <span class="c1"># cell ID</span>
			<span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">:</span> <span class="s2">&quot;:0.3f&quot;</span><span class="p">,</span><span class="c1"># UMAP coordinates rounded to 3 decimals</span>
			<span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">:</span> <span class="s2">&quot;:0.3f&quot;</span><span class="p">,</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">variable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">hover_data</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># type: ignore # when plotting gene expression, also show cell types when mouse hover</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">gene</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">hover_data</span><span class="p">[</span><span class="n">gene</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;:.3f&quot;</span> <span class="c1"># type: ignore</span>
	<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
		<span class="n">obs</span><span class="p">,</span>
		<span class="n">x</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">,</span>          <span class="c1"># UMAP first dimension → X axis</span>
		<span class="n">y</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">,</span>          <span class="c1"># UMAP second dimension → Y axis</span>
		<span class="n">color</span><span class="o">=</span><span class="n">use_col</span><span class="p">,</span> 
		<span class="n">hover_data</span><span class="o">=</span><span class="n">hover_data</span><span class="p">,</span>
		<span class="n">range_color</span><span class="o">=</span><span class="n">range_color</span><span class="p">,</span>
		<span class="n">color_discrete_sequence</span><span class="o">=</span><span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">D3</span><span class="p">,</span> <span class="c1"># color palette (professional, unobtrusive)</span>
		<span class="n">color_discrete_map</span><span class="o">=</span><span class="n">color_discrete_map</span><span class="p">,</span>
		<span class="n">color_continuous_scale</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="c1">#[&quot;blue&quot;, &quot;red&quot;],</span>
		<span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_white&quot;</span><span class="p">,</span>
		<span class="n">render_mode</span><span class="o">=</span><span class="s1">&#39;webgl&#39;</span>  <span class="c1"># use WebGL rendering for better performance with large datasets</span>
	<span class="p">)</span>
	<span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">obs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">obs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.5</span><span class="p">],</span><span class="n">tickfont_size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
	<span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">obs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">obs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.5</span><span class="p">],</span><span class="n">tickfont_size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="c1"># Blend an area-based marker estimate with a log-based fallback so total point count and canvas size both matter.</span>
		<span class="c1"># Increased target_fill and scaling to make markers bigger</span>
		<span class="n">marker_diam_area</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="n">target_fill</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">n_points</span><span class="p">))</span>
		<span class="n">marker_diam_log</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span>
		<span class="n">marker_diam</span> <span class="o">=</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">marker_diam_area</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">marker_diam_log</span>
		<span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">marker_diam</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
	<span class="k">if</span> <span class="n">n_points</span> <span class="o">&lt;</span> <span class="mi">500000</span><span class="p">:</span>
		<span class="n">opacity</span> <span class="o">=</span> <span class="mf">0.8</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">opacity</span> <span class="o">=</span> <span class="mf">0.6</span>
	<span class="c1"># logger.debug(f&quot;{variable},{gene},{use_col}&quot;)</span>
	<span class="c1"># print(color_discrete_map,size,opacity)</span>
	<span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span>
		<span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="n">opacity</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)),</span>
		<span class="n">selector</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">)</span>
	<span class="p">)</span>
	<span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coord</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> Visualization (Colored by </span><span class="si">{</span><span class="n">use_col</span><span class="si">}</span><span class="s2">)&quot;</span>
	<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
		<span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
			<span class="n">text</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
			<span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
			<span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># center the title</span>
			<span class="n">pad</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
		<span class="p">),</span>
		<span class="n">xaxis_title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
		<span class="n">yaxis_title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
		<span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
		<span class="n">legend_title</span><span class="o">=</span><span class="n">use_col</span><span class="p">,</span> <span class="c1"># legend title</span>
		<span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
			<span class="n">font_size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
			<span class="n">itemsizing</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span>  <span class="c1"># important: fix legend marker size so it&#39;s not affected by scatter points</span>
			<span class="n">itemwidth</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">borderwidth</span><span class="o">=</span><span class="mf">0.1</span>          <span class="c1"># legend item width; larger value increases the marker size</span>
		<span class="p">)</span>
	<span class="p">)</span>
	<span class="k">if</span> <span class="n">show</span><span class="p">:</span>
		<span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coord</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">use_col</span><span class="si">}</span><span class="s2">&quot;</span>
		<span class="n">show_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">fig</span></div>

	<span class="c1"># html=fig2div(fig,filename=&#39;umap_plot&#39;)</span>
	<span class="c1"># return HttpResponse(html)</span>

<div class="viewcode-block" id="show_fig">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.show_fig">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">show_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;plot&quot;</span><span class="p">):</span>
    <span class="n">interactive_config</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;displayModeBar&#39;</span><span class="p">:</span><span class="s1">&#39;hover&#39;</span><span class="p">,</span><span class="s1">&#39;showLink&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;linkText&#39;</span><span class="p">:</span><span class="s1">&#39;Edit on plotly&#39;</span><span class="p">,</span>\
        <span class="s1">&#39;scrollZoom&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s2">&quot;displaylogo&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>\
        <span class="s1">&#39;toImageButtonOptions&#39;</span><span class="p">:{</span><span class="s1">&#39;format&#39;</span><span class="p">:</span><span class="s1">&#39;svg&#39;</span><span class="p">,</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span><span class="n">filename</span><span class="p">},</span>\
        <span class="s1">&#39;modeBarButtonsToRemove&#39;</span><span class="p">:[</span><span class="s1">&#39;sendDataToCloud&#39;</span><span class="p">,</span><span class="s1">&#39;pan2d&#39;</span><span class="p">,</span><span class="s1">&#39;zoom2d&#39;</span><span class="p">,</span><span class="s1">&#39;zoom3d&#39;</span><span class="p">,</span><span class="s1">&#39;zoomIn2d&#39;</span><span class="p">,</span><span class="s1">&#39;zoomOut2d&#39;</span><span class="p">],</span>\
        <span class="s1">&#39;editable&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;autosizable&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;responsive&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;fillFrame&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span> \
        <span class="s1">&#39;edits&#39;</span><span class="p">:{</span>
            <span class="s1">&#39;titleText&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;legendPosition&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;colorbarTitleText&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;shapePosition&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;annotationPosition&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;annotationText&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;axisTitleText&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;legendText&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;colorbarPosition&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">}</span>
    <span class="p">}</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">interactive_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="stacked_barplot">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.stacked_barplot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">stacked_barplot</span><span class="p">(</span>
		<span class="n">obs</span><span class="o">=</span><span class="s2">&quot;cell_obs_with_annotation.csv&quot;</span><span class="p">,</span><span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span>
		<span class="n">column</span><span class="o">=</span><span class="s1">&#39;CellClass&#39;</span><span class="p">,</span><span class="n">x_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">y_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
		<span class="n">palette</span><span class="o">=</span><span class="s2">&quot;~/Projects/mouse_pfc/obs/mpfc_color_palette.xlsx&quot;</span><span class="p">,</span>
		<span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">xticklabels_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
		<span class="n">lgd_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">sort_by</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Plot stacked barplto to show the cell type composition in each `groupby` (</span>
<span class="sd">		such as Age, brain regions and so on.)</span>
<span class="sd">		For example: stacked_barplot(column=&#39;MajorType&#39;,width=3.5,height=6)</span>
<span class="sd">							stacked_barplot(column=&#39;CellClass&#39;,width=3.5,height=3)</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
		<span class="n">data</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obs</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.h5ad&#39;</span><span class="p">):</span>
		<span class="n">obs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">obs</span><span class="p">))</span>
		<span class="n">adata</span> <span class="o">=</span> <span class="n">anndata</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">obs_path</span><span class="p">,</span><span class="n">backed</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
		<span class="n">data</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span>
		<span class="k">del</span> <span class="n">adata</span>
	<span class="k">elif</span> <span class="n">obs</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">):</span>
		<span class="n">obs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">obs</span><span class="p">))</span>
		<span class="n">data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">obs_path</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">obs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">obs</span><span class="p">))</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">obs_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
	<span class="n">xticklabels_kws</span><span class="o">=</span><span class="p">{}</span> <span class="k">if</span> <span class="n">xticklabels_kws</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">xticklabels_kws</span>
	<span class="n">xticklabels_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;rotation&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">45</span><span class="p">)</span>
	<span class="n">xticklabels_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;rotation_mode&quot;</span><span class="p">,</span> <span class="s2">&quot;anchor&quot;</span><span class="p">)</span>
	<span class="n">xticklabels_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;horizontalalignment&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span> <span class="c1">#see ?matplotlib.axes.Axes.tick_params</span>
	<span class="n">xticklabels_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;verticalalignment&#39;</span><span class="p">,</span> <span class="s1">&#39;center&#39;</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">palette</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">palette</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
			<span class="n">color_palette</span><span class="o">=</span><span class="n">palette</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">palette</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">palette</span><span class="p">)):</span>
			<span class="n">palette</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">palette</span><span class="p">))</span>
			<span class="n">D</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">palette</span><span class="p">,</span>
							<span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">color_palette</span><span class="o">=</span><span class="n">D</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">Hex</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
			<span class="n">keys</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">color_palette</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
			<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
					<span class="n">color_palette</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">color_palette</span> <span class="o">=</span> <span class="n">palette</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">color_palette</span><span class="o">=</span><span class="kc">None</span>
	<span class="n">df</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby</span><span class="p">)[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">column</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">sort_by</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sort_by</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">x_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">x_order</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
		<span class="k">if</span> <span class="n">y_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">y_order</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
		<span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x_order</span><span class="p">,</span><span class="n">y_order</span><span class="p">]</span>
	<span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">width</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.45</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="mf">2.5</span><span class="p">:</span>
			<span class="n">width</span><span class="o">=</span><span class="mf">2.5</span>
	<span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="mf">3.5</span><span class="p">:</span>
			<span class="n">height</span> <span class="o">=</span> <span class="mf">3.5</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
	<span class="n">ax</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">align</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">gap</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
				   <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">),</span>
				   <span class="n">color</span><span class="o">=</span><span class="n">color_palette</span><span class="p">)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">tick</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()]</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">),</span>
				  <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span><span class="o">**</span><span class="n">xticklabels_kws</span><span class="p">)</span> <span class="c1"># ax.xaxis.set_major_locator(ticker.FixedLocator(np.arange(0.5,df.shape[1],1))) #ticker.MultipleLocator(0.5)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span>
		<span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="c1">#both</span>
		<span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span><span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">labelright</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
		<span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">labeltop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="c1">#bottom=False,labelbottom=False</span>
		<span class="p">)</span>
	<span class="c1"># ax.xaxis.set_tick_params(axis=&#39;x&#39;)</span>
	<span class="n">lgd_kws</span> <span class="o">=</span> <span class="n">lgd_kws</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">lgd_kws</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>  <span class="c1"># bbox_to_anchor=(x,-0.05)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;frameon&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;ncol&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">lgd_kws</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;upper left&quot;</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;borderpad&quot;</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">25.4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">72</span><span class="p">)</span>  <span class="c1"># 0.1mm</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;markerscale&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;handleheight&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># font size, units is points</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;handlelength&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># font size, units is points</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;borderaxespad&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># The pad between the axes and legend border, in font-size units.</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;handletextpad&quot;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>  <span class="c1"># The pad between the legend handle and text, in font-size units.</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;labelspacing&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># gap height between two Patches,  0.05*mm2inch*72</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;columnspacing&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;bbox_to_anchor&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
	<span class="n">lgd_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span><span class="n">column</span><span class="p">)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">**</span><span class="n">lgd_kws</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">save</span><span class="p">:</span>
		<span class="n">outdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">save</span><span class="p">))</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
			<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save</span><span class="p">)</span> <span class="c1"># transparent=True,bbox_inches=&#39;tight&#39;,dpi=300</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="pieplot">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.pieplot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pieplot</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="s2">&quot;cell_obs_with_annotation.csv&quot;</span><span class="p">,</span><span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;figures&quot;</span><span class="p">,</span>
			<span class="n">palette_path</span><span class="o">=</span><span class="s2">&quot;~/Projects/mouse_pfc/obs/mpfc_color_palette.xlsx&quot;</span><span class="p">,</span>
			<span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">explode</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
	<span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">outdir</span><span class="p">))</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
		<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
	<span class="c1"># colors=None</span>
	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
		<span class="n">data</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obs</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.h5ad&#39;</span><span class="p">):</span>
		<span class="n">obs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">obs</span><span class="p">))</span>
		<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading adata: </span><span class="si">{</span><span class="n">obs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
		<span class="n">adata</span> <span class="o">=</span> <span class="n">anndata</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">obs_path</span><span class="p">,</span> <span class="n">backed</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
		<span class="c1"># if f&#39;{groupby}_colors&#39; in adata.uns:</span>
		<span class="c1">#     colors={k:v for k,v in zip(adata.obs[groupby].cat.categories.tolist(),</span>
		<span class="c1">#                                adata.uns[f&#39;{groupby}_colors&#39;])}</span>
		<span class="c1"># else:</span>
		<span class="c1">#     colors=None</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span>
		<span class="k">del</span> <span class="n">adata</span>
	<span class="k">elif</span> <span class="n">obs</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">):</span>
		<span class="n">obs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">obs</span><span class="p">))</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">obs_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">obs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">obs</span><span class="p">))</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">obs_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

	<span class="k">if</span> <span class="ow">not</span> <span class="n">palette_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">palette_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">palette_path</span><span class="p">))</span>
		<span class="n">D</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">palette_path</span><span class="p">,</span>
						<span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">color_palette</span><span class="o">=</span><span class="n">D</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">Hex</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">color_palette</span><span class="o">=</span><span class="kc">None</span>
	<span class="n">D</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">order</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

	<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">pie</span><span class="p">([</span><span class="n">D</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">order</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
			<span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="n">color_palette</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">order</span><span class="p">],</span>
			<span class="n">explode</span><span class="o">=</span><span class="p">[</span><span class="n">explode</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">),</span> <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.1f%%</span><span class="s1">&#39;</span><span class="p">)</span>
	<span class="c1"># Add title to the chart</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of #of cells across different stages&#39;</span><span class="p">)</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">groupby</span> <span class="o">+</span> <span class="s1">&#39;.piechart.pdf&#39;</span><span class="p">))</span> <span class="c1"># transparent=True,bbox_inches=&#39;tight&#39;,dpi=300</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_pseudotime">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.plot_pseudotime">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_pseudotime</span><span class="p">(</span>
	<span class="n">pseudotime</span><span class="o">=</span><span class="s2">&quot;dpt_pseudotime.tsv&quot;</span><span class="p">,</span><span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;dpt_pseudotime&#39;</span><span class="p">,</span>
	<span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mf">3.5</span><span class="p">),</span><span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;figures&quot;</span><span class="p">,</span><span class="n">rotate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Pseudotime&#39;</span><span class="p">,</span>
	<span class="n">palette_path</span><span class="o">=</span><span class="s2">&quot;~/Projects/mouse_pfc/obs/mpfc_color_palette.xlsx&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Plot pseudotime. plot_pseudotime(figsize=(6,3.5),groupby=&#39;MajorType&#39;,</span>
<span class="sd">									rotate=-45);</span>
<span class="sd">								plot_pseudotime(figsize=(3.5,3),groupby=&#39;CellClass&#39;)</span>
<span class="sd">								plot_pseudotime(figsize=(3.5,3),groupby=&#39;Age&#39;)</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	pseudotime :</span>
<span class="sd">	groupby :</span>
<span class="sd">	y :</span>
<span class="sd">	hue :</span>
<span class="sd">	figsize :</span>
<span class="sd">	outdir :</span>
<span class="sd">	rotate :</span>
<span class="sd">	palette_path :</span>

<span class="sd">	Returns</span>
<span class="sd">	-------</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">outdir</span><span class="p">))</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
		<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">palette_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">palette_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">palette_path</span><span class="p">))</span>
		<span class="n">D</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">palette_path</span><span class="p">,</span>
						<span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">color_palette</span><span class="o">=</span><span class="n">D</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span><span class="o">.</span><span class="n">Hex</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">color_palette</span><span class="o">=</span><span class="kc">None</span>

	<span class="n">data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">pseudotime</span><span class="p">),</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
	<span class="n">data</span><span class="o">.</span><span class="n">dpt_pseudotime</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">order</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby</span><span class="p">)[</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">hue_order</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">hue</span><span class="p">)[</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">hue_order</span><span class="o">=</span><span class="kc">None</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
	<span class="c1"># ax = sns.swarmplot(data=data, palette=color_palette, \</span>
	<span class="c1"># 				   edgecolor=&#39;white&#39;, x=groupby, y=y, \</span>
	<span class="c1"># 				   order=order)</span>
	<span class="n">ax</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
				   <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">bw</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">inner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">saturation</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
				   <span class="n">palette</span><span class="o">=</span><span class="n">color_palette</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span><span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span><span class="n">hue_order</span><span class="o">=</span><span class="n">hue_order</span><span class="p">)</span>
	<span class="c1"># plt.legend(frameon=True)</span>
	<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">rotate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_majorticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="n">rotate</span><span class="p">,</span>
				 <span class="n">rotation_mode</span><span class="o">=</span><span class="s2">&quot;anchor&quot;</span><span class="p">,</span><span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
	<span class="n">outname</span><span class="o">=</span><span class="n">groupby</span> <span class="o">+</span> <span class="s1">&#39;.pseudotime_violin.pdf&#39;</span> <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">groupby</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">hue</span><span class="si">}</span><span class="s1">.pseudotime_violin.pdf&#39;</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">outname</span><span class="p">))</span> <span class="c1"># transparent=True,bbox_inches=&#39;tight&#39;,dpi=300</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="stacked_violinplot">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.stacked_violinplot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">stacked_violinplot</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">use_genes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span>
					   <span class="n">cell_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">):</span>
	<span class="kn">import</span><span class="w"> </span><span class="nn">scanpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
	<span class="n">ax</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">stacked_violin</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cell_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">==</span><span class="n">parent</span><span class="p">],</span>
            <span class="n">var_names</span><span class="o">=</span><span class="n">use_genes</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">use_key</span><span class="p">,</span> <span class="n">colorbar_title</span><span class="o">=</span><span class="s2">&quot;Avg mc frac&quot;</span><span class="p">,</span>
            <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span><span class="p">,</span> <span class="n">dendrogram</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">swap_axes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">standard_scale</span><span class="o">=</span><span class="s1">&#39;obs&#39;</span><span class="p">,</span> <span class="n">inner</span><span class="o">=</span><span class="s1">&#39;quart&#39;</span><span class="p">,</span>
            <span class="c1"># stripplot=False,jitter=False,</span>
            <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
	<span class="n">ax1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;mainplot_ax&#39;</span><span class="p">]</span>
	<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
	<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span><span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
				<span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">5</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">)</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fig_basename</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">groupby</span><span class="si">}</span><span class="s2">.stacked_violin.pdf&quot;</span><span class="p">)</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="categorical_scatter">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.categorical_scatter">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">categorical_scatter</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">coord_base</span><span class="o">=</span><span class="s2">&quot;umap&quot;</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># coords</span>
    <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">palette</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># color</span>
    <span class="n">text_anno</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">text_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">luminance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">text_transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dodge_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">dodge_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># text annotation</span>
    <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">legend_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># legend</span>
    <span class="n">s</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># sizes is a dict</span>
    <span class="n">size_norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">size_portion</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> 
    <span class="n">axis_format</span><span class="o">=</span><span class="s2">&quot;tiny&quot;</span><span class="p">,</span><span class="n">max_points</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span>
    <span class="n">labelsize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">zoomxy</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span>
    <span class="n">outline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">outline_pad</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">outline_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">scatter_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rasterized</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span><span class="n">coding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
	<span class="n">id_marker</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">legend_color_text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
	<span class="n">rectangle_marker</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">marker_fontsize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">marker_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	This function was copied from ALLCools and made some modifications.</span>
<span class="sd">	Plot categorical scatter plot with versatile options.</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	rasterized</span>
<span class="sd">		Whether to rasterize the figure.</span>
<span class="sd">	return_fig</span>
<span class="sd">		Whether to return the figure.</span>
<span class="sd">	size_portion</span>
<span class="sd">		The portion of the figure to be used for the size norm.</span>
<span class="sd">	data</span>
<span class="sd">		Dataframe that contains coordinates and categorical variables</span>
<span class="sd">	ax</span>
<span class="sd">		this function do not generate ax, must provide an ax</span>
<span class="sd">	coord_base</span>
<span class="sd">		coords name, if provided, will automatically search for x and y</span>
<span class="sd">	x</span>
<span class="sd">		x coord name</span>
<span class="sd">	y</span>
<span class="sd">		y coord name</span>
<span class="sd">	hue : str</span>
<span class="sd">		categorical col name or series for color hue.</span>
<span class="sd">	palette : str or dict</span>
<span class="sd">		palette for color hue.</span>
<span class="sd">	color</span>
<span class="sd">		specify single color for all the dots</span>
<span class="sd">	text_anno</span>
<span class="sd">		categorical col name or series for text annotation.</span>
<span class="sd">	text_kws</span>
<span class="sd">		kwargs pass to plt.text, see: https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.text.html</span>
<span class="sd">		including bbox, to see parameter for bbox, go to: https://matplotlib.org/stable/api/_as_gen/matplotlib.patches.FancyBboxPatch.html#matplotlib.patches.FancyBboxPatch</span>
<span class="sd">		commonly used parameters are::</span>

<span class="sd">			text_kws=dict(fontsize=5,fontweight=&#39;black&#39;,</span>
<span class="sd">						color=&#39;black&#39;, # color could be a dict, keys are text to be annotated</span>
<span class="sd">						bbox=dict(boxstyle=&#39;round&#39;,edgecolor=(0.5, 0.5, 0.5, 0.2),fill=False,</span>
<span class="sd">									facecolor=(0.8, 0.8, 0.8, 0.2), # facecolor could also be a dict</span>
<span class="sd">									alpha=1,linewidth=0.5)</span>
<span class="sd">						)</span>
<span class="sd">	text_transform</span>
<span class="sd">		transform for text annotation.</span>
<span class="sd">	dodge_text</span>
<span class="sd">		whether to dodge text annotation.</span>
<span class="sd">	dodge_kws</span>
<span class="sd">		kwargs for dodge text annotation.</span>
<span class="sd">	show_legend</span>
<span class="sd">		whether to show legend.</span>
<span class="sd">	legend_kws</span>
<span class="sd">		kwargs for legend.</span>
<span class="sd">	s</span>
<span class="sd">		single size value of all the dots.</span>
<span class="sd">	size</span>
<span class="sd">		mappable size of the dots.</span>
<span class="sd">	sizes</span>
<span class="sd">		mapping size to the sizes value.</span>
<span class="sd">	size_norm</span>
<span class="sd">		normalize size range for mapping.</span>
<span class="sd">	axis_format</span>
<span class="sd">		axis format.</span>
<span class="sd">	max_points</span>
<span class="sd">		maximum number of points to plot.</span>
<span class="sd">	labelsize</span>
<span class="sd">		label size pass to `ax.text`</span>
<span class="sd">	linewidth</span>
<span class="sd">		line width pass to `ax.scatter`</span>
<span class="sd">	zoomxy</span>
<span class="sd">		zoom factor for x and y-axis.</span>
<span class="sd">	outline</span>
<span class="sd">		categorical col name or series for outline.</span>
<span class="sd">	outline_pad</span>
<span class="sd">		outline padding.</span>
<span class="sd">	outline_kws</span>
<span class="sd">		kwargs for outline.</span>
<span class="sd">	scatter_kws</span>
<span class="sd">		kwargs for scatter.</span>

<span class="sd">	Returns</span>
<span class="sd">	-------</span>
<span class="sd">	if return_fig is True, return the figure and axes.</span>
<span class="sd">	else, return None.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="c1"># fig, ax = plt.subplots(figsize=(4, 4), dpi=300)</span>
		<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
	<span class="c1"># add coords</span>
	<span class="n">_data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_extract_coords</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">coord_base</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
	<span class="c1"># _data has 2 cols: &quot;x&quot; and &quot;y&quot;, index are obs_names</span>

	<span class="c1"># down sample plot data if needed.</span>
	<span class="k">if</span> <span class="n">max_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_points</span><span class="p">:</span>
			<span class="n">_data</span> <span class="o">=</span> <span class="n">_density_based_sample</span><span class="p">(</span><span class="n">_data</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">max_points</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
	<span class="n">n_dots</span> <span class="o">=</span> <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

	<span class="c1"># determine rasterized</span>
	<span class="k">if</span> <span class="n">rasterized</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">n_dots</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
			<span class="n">rasterized</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">rasterized</span> <span class="o">=</span> <span class="kc">False</span>

	<span class="c1"># auto size if user didn&#39;t provide one</span>
	<span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">_auto_size</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">n_dots</span><span class="p">)</span>

	<span class="c1"># default scatter options</span>
	<span class="n">_scatter_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span> <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;palette&quot;</span><span class="p">:</span> <span class="n">palette</span><span class="p">,</span> <span class="s2">&quot;rasterized&quot;</span><span class="p">:</span> <span class="n">rasterized</span><span class="p">}</span>
	<span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one of color and hue can be provided&quot;</span><span class="p">)</span>
		<span class="n">_scatter_kws</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
	<span class="k">if</span> <span class="n">scatter_kws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">_scatter_kws</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scatter_kws</span><span class="p">)</span>

	<span class="c1"># deal with color</span>
	<span class="n">palette_dict</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;hue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_take_data_series</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hue</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;hue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hue</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;hue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="s2">&quot;hue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">remove_unused_categories</span><span class="p">()</span>

		<span class="c1"># if the object has get_palette method, use it (AnnotZarr)</span>
		<span class="n">palette</span> <span class="o">=</span> <span class="n">_scatter_kws</span><span class="p">[</span><span class="s2">&quot;palette&quot;</span><span class="p">]</span>
		<span class="c1"># deal with other color palette</span>
		<span class="k">if</span> <span class="n">palette_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">palette</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">palette</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
				<span class="n">palette_dict</span> <span class="o">=</span> <span class="n">level_one_palette</span><span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="s2">&quot;hue&quot;</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">)</span>
			<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">palette</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
				<span class="n">palette_dict</span> <span class="o">=</span> <span class="n">palette</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Palette can only be str, list or dict, &quot;</span> <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
		<span class="n">_scatter_kws</span><span class="p">[</span><span class="s2">&quot;palette&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">palette_dict</span>

	<span class="c1"># deal with size</span>
	<span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_take_data_series</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="s2">&quot;size&quot;</span>

		<span class="k">if</span> <span class="n">size_norm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="c1"># get the smallest range that include &quot;size_portion&quot; of data</span>
			<span class="n">size_norm</span> <span class="o">=</span> <span class="n">tight_hue_range</span><span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">],</span> <span class="n">size_portion</span><span class="p">)</span>

			<span class="c1"># snorm is the normalizer for size</span>
			<span class="n">size_norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">size_norm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">size_norm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

		<span class="c1"># discard s from _scatter_kws and use size in sns.scatterplot</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">_scatter_kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">sizes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">sizes</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">s</span><span class="p">)</span>

	<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
		<span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
		<span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
		<span class="n">data</span><span class="o">=</span><span class="n">_data</span><span class="p">,</span>
		<span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
		<span class="n">hue</span><span class="o">=</span><span class="s2">&quot;hue&quot;</span><span class="p">,</span>
		<span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
		<span class="n">sizes</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span>
		<span class="n">size_norm</span><span class="o">=</span><span class="n">size_norm</span><span class="p">,</span>
		<span class="o">**</span><span class="n">_scatter_kws</span><span class="p">,</span>
	<span class="p">)</span>

	<span class="c1"># deal with text annotation</span>
	<span class="n">code2label</span><span class="o">=</span><span class="kc">None</span>
	<span class="k">if</span> <span class="n">text_anno</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="c1"># data</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_anno</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;text_anno&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_take_data_series</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">text_anno</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;text_anno&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text_anno</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="s2">&quot;text_anno&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;text_anno&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="s2">&quot;text_anno&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">remove_unused_categories</span><span class="p">()</span>

		<span class="c1"># text kws</span>
		<span class="n">text_kws</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">text_kws</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">text_kws</span>
		<span class="n">default_text_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>  <span class="c1"># color for the text, could be a dict, keys are text to be annotated</span>
			<span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="c1">#fontsize=labelsize,</span>
			<span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">palette_dict</span><span class="p">,</span> <span class="c1"># if None, use default color</span>
				<span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="c1">#ellipse, round</span>
				<span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">))</span>
		<span class="c1"># coding &amp; id_marker</span>
		<span class="n">text_anno</span><span class="o">=</span><span class="s1">&#39;text_anno&#39;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">coding</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">coding</span><span class="o">!=</span><span class="kc">False</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">coding</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
				<span class="n">_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="s1">&#39;hue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span> <span class="c1">#int</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coding</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
				<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_take_data_series</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">coding</span><span class="p">)</span>
				<span class="n">_data</span><span class="o">=</span><span class="n">_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
				<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">_data</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">remove_unused_categories</span><span class="p">()</span>
			<span class="n">text_anno</span><span class="o">=</span><span class="s1">&#39;code&#39;</span>
			<span class="n">_data</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="s1">&#39;hue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">palette_dict</span><span class="p">)</span>
			<span class="n">code2label</span><span class="o">=</span><span class="n">_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="s1">&#39;hue&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">hue</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
			<span class="n">_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
			<span class="n">code_colors</span><span class="o">=</span><span class="n">_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="s1">&#39;color&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
			<span class="n">default_text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">][</span><span class="s1">&#39;facecolor&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">code_colors</span> <span class="c1"># background colors for text annotation</span>
			<span class="n">default_text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">][</span><span class="s1">&#39;boxstyle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;circle&#39;</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">default_text_kws</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">k</span> <span class="o">!=</span><span class="s1">&#39;bbox&#39;</span><span class="p">:</span>
				<span class="n">text_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">default_text_kws</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="s1">&#39;bbox&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text_kws</span><span class="p">:</span>
					<span class="n">text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
				<span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="n">default_text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]:</span>
					<span class="n">text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">default_text_kws</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">][</span><span class="n">k1</span><span class="p">])</span>

		<span class="n">_text_anno_scatter</span><span class="p">(</span>
			<span class="n">data</span><span class="o">=</span><span class="n">_data</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">text_anno</span><span class="p">]],</span>
			<span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
			<span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
			<span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
			<span class="n">dodge_text</span><span class="o">=</span><span class="n">dodge_text</span><span class="p">,</span>
			<span class="n">dodge_kws</span><span class="o">=</span><span class="n">dodge_kws</span><span class="p">,</span>
			<span class="n">text_transform</span><span class="o">=</span><span class="n">text_transform</span><span class="p">,</span>
			<span class="n">anno_col</span><span class="o">=</span><span class="n">text_anno</span><span class="p">,</span>
			<span class="n">text_kws</span><span class="o">=</span><span class="n">text_kws</span><span class="p">,</span>
			<span class="n">luminance</span><span class="o">=</span><span class="n">luminance</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="c1"># deal with outline</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">outline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outline</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;outline&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_take_data_series</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outline</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;outline&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outline</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="n">_outline_kws</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="n">linewidth</span><span class="p">,</span>
			<span class="s2">&quot;palette&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
			<span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;lightgray&quot;</span><span class="p">,</span>
			<span class="s2">&quot;single_contour_pad&quot;</span><span class="p">:</span> <span class="n">outline_pad</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="n">outline_kws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">_outline_kws</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">outline_kws</span><span class="p">)</span>
		<span class="n">density_contour</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;outline&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">_outline_kws</span><span class="p">)</span>

	<span class="c1"># clean axis</span>
	<span class="k">if</span> <span class="n">axis_format</span> <span class="o">==</span> <span class="s2">&quot;tiny&quot;</span><span class="p">:</span>
		<span class="n">_make_tiny_axis_label</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">arrow_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">labelsize</span><span class="p">)</span>
	<span class="k">elif</span> <span class="p">(</span><span class="n">axis_format</span> <span class="o">==</span> <span class="s2">&quot;empty&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">axis_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
		<span class="n">despine</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="c1"># deal with legend</span>
	<span class="k">if</span> <span class="n">show_legend</span> <span class="ow">and</span> <span class="p">(</span><span class="n">hue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
		<span class="n">n_hue</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette_dict</span><span class="p">)</span>
		<span class="n">ncol</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="n">n_hue</span> <span class="o">&lt;=</span> <span class="mi">40</span> <span class="k">else</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">n_hue</span> <span class="o">&lt;=</span> <span class="mi">100</span> <span class="k">else</span> <span class="mi">3</span>
		<span class="k">if</span> <span class="n">legend_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">legend_kws</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">default_lgd_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
			<span class="n">ncol</span><span class="o">=</span><span class="n">ncol</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">labelsize</span><span class="p">,</span>
			<span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span>
			<span class="c1"># borderpad=0.4, # pad between marker (text) and border</span>
			<span class="c1"># labelspacing=0.2, #The vertical space between the legend entries, in font-size units</span>
			<span class="c1"># handleheight=0.5, #The height of the legend handles, in font-size units.</span>
			<span class="c1"># handletextpad=0.2, # The pad between the legend handle (marker) and text, in font-size units.</span>
			<span class="c1"># borderaxespad=0.3, # The pad between the Axes and legend border, in font-size units</span>
			<span class="c1"># columnspacing=0.2, #The spacing between columns, in font-size units</span>
			<span class="n">markersize</span><span class="o">=</span><span class="n">labelsize</span> <span class="c1">#legend_kws[&quot;fontsize&quot;],</span>
		<span class="p">)</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">default_lgd_kws</span><span class="p">:</span>
			<span class="n">legend_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">default_lgd_kws</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

		<span class="n">exist_hues</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="s2">&quot;hue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
		<span class="n">color_dict</span><span class="o">=</span><span class="p">{</span><span class="n">hue_name</span><span class="p">:</span> <span class="n">color</span> <span class="k">for</span> <span class="n">hue_name</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">palette_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">hue_name</span> <span class="ow">in</span> <span class="n">exist_hues</span><span class="p">}</span>
		
		<span class="k">if</span> <span class="ow">not</span> <span class="n">code2label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">id_marker</span><span class="p">:</span>
			<span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;Circle&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">rectangle_marker</span> <span class="k">else</span> <span class="s1">&#39;Round&#39;</span>
			<span class="n">plot_text_legend</span><span class="p">(</span><span class="n">color_dict</span><span class="p">,</span> <span class="n">code2label</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> 
					<span class="n">color_text</span><span class="o">=</span><span class="n">legend_color_text</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="n">boxstyle</span><span class="p">,</span><span class="n">marker_pad</span><span class="o">=</span><span class="n">marker_pad</span><span class="p">,</span>
					<span class="n">legend_kws</span><span class="o">=</span><span class="n">legend_kws</span><span class="p">,</span><span class="n">marker_fontsize</span><span class="o">=</span><span class="n">marker_fontsize</span><span class="p">,</span>
					<span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span><span class="n">luminance</span><span class="o">=</span><span class="n">luminance</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">rectangle_marker</span><span class="p">:</span>
				<span class="c1">## plot Patch legend (rectangle marker)</span>
				<span class="n">plot_color_dict_legend</span><span class="p">(</span>
					<span class="n">D</span><span class="o">=</span><span class="n">color_dict</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">color_text</span><span class="o">=</span><span class="n">legend_color_text</span><span class="p">,</span> 
					<span class="n">kws</span><span class="o">=</span><span class="n">legend_kws</span><span class="p">,</span><span class="n">luminance</span><span class="o">=</span><span class="n">luminance</span>
				<span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="c1"># plot marker legend (for example, circle marker)</span>
				<span class="n">plot_marker_legend</span><span class="p">(</span>
					<span class="n">color_dict</span><span class="o">=</span><span class="n">color_dict</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">color_text</span><span class="o">=</span><span class="n">legend_color_text</span><span class="p">,</span> 
					<span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">kws</span><span class="o">=</span><span class="n">legend_kws</span><span class="p">,</span><span class="n">luminance</span><span class="o">=</span><span class="n">luminance</span>
				<span class="p">)</span>

	<span class="k">if</span> <span class="n">zoomxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">zoom_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">zoomxy</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">_data</span></div>


<div class="viewcode-block" id="get_cmap">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.get_cmap">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">):</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">colormaps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>  <span class="c1"># matplotlib &gt;= 3.5.1?</span>
	<span class="k">except</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>  <span class="c1"># matplotlib &lt;=3.4.3?</span></div>

	
<div class="viewcode-block" id="continuous_scatter">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.continuous_scatter">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">continuous_scatter</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">coord_base</span><span class="o">=</span><span class="s2">&quot;umap&quot;</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">scatter_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hue_norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hue_portion</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
    <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">size_norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">size_portion</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
    <span class="n">sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sizebar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">text_anno</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dodge_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">dodge_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">text_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">luminance</span><span class="o">=</span><span class="mf">0.48</span><span class="p">,</span>
    <span class="n">text_transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">axis_format</span><span class="o">=</span><span class="s2">&quot;tiny&quot;</span><span class="p">,</span>
    <span class="n">max_points</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
	<span class="n">ticklabel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">zoomxy</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span>
    <span class="n">outline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">outline_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">outline_pad</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">return_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">rasterized</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">cbar_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cbar_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Plot scatter on given adata.</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	data : _type_</span>
<span class="sd">		_description_</span>
<span class="sd">	ax : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	coord_base : str, optional</span>
<span class="sd">		_description_, by default &quot;umap&quot;</span>
<span class="sd">	x : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	y : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	scatter_kws : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	hue : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	hue_norm : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	hue_portion : float, optional</span>
<span class="sd">		_description_, by default 0.95</span>
<span class="sd">	color : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	cmap : str, optional</span>
<span class="sd">		_description_, by default &quot;viridis&quot;</span>
<span class="sd">	colorbar : bool, optional</span>
<span class="sd">		_description_, by default True</span>
<span class="sd">	size : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	size_norm : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	size_portion : float, optional</span>
<span class="sd">		_description_, by default 0.95</span>
<span class="sd">	sizes : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	sizebar : bool, optional</span>
<span class="sd">		_description_, by default True</span>
<span class="sd">	text_anno : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	dodge_text : bool, optional</span>
<span class="sd">		_description_, by default False</span>
<span class="sd">	dodge_kws : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	text_kws : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	luminance : float, optional</span>
<span class="sd">		_description_, by default 0.48</span>
<span class="sd">	text_transform : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	axis_format : str, optional</span>
<span class="sd">		_description_, by default &quot;tiny&quot;</span>
<span class="sd">	max_points : int, optional</span>
<span class="sd">		_description_, by default 50000</span>
<span class="sd">	s : str, optional</span>
<span class="sd">		_description_, by default &quot;auto&quot;</span>
<span class="sd">	labelsize : int, optional</span>
<span class="sd">		_description_, by default 6</span>
<span class="sd">	ticklabel_size : int, optional</span>
<span class="sd">		_description_, by default 4</span>
<span class="sd">	linewidth : float, optional</span>
<span class="sd">		_description_, by default 0.5</span>
<span class="sd">	zoomxy : float, optional</span>
<span class="sd">		_description_, by default 1.05</span>
<span class="sd">	outline : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	outline_kws : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	outline_pad : int, optional</span>
<span class="sd">		_description_, by default 2</span>
<span class="sd">	return_fig : bool, optional</span>
<span class="sd">		_description_, by default False</span>
<span class="sd">	rasterized : str, optional</span>
<span class="sd">		_description_, by default &quot;auto&quot;</span>
<span class="sd">	cbar_kws : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	cbar_width : int, optional</span>
<span class="sd">		width of colorbar, by default 3 mm</span>

<span class="sd">	Returns</span>
<span class="sd">	-------</span>
<span class="sd">	_type_</span>
<span class="sd">		_description_</span>

<span class="sd">	Raises</span>
<span class="sd">	------</span>
<span class="sd">	ValueError</span>
<span class="sd">		_description_</span>
<span class="sd">	TypeError</span>
<span class="sd">		_description_</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
	<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
	<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.cm</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScalarMappable</span>
	<span class="c1"># init figure if not provided</span>
	<span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>

	<span class="c1"># add coords</span>
	<span class="n">_data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_extract_coords</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">coord_base</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
	<span class="c1"># _data has 2 cols: &quot;x&quot; and &quot;y&quot;</span>

	<span class="c1"># down sample plot data if needed.</span>
	<span class="k">if</span> <span class="n">max_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_points</span><span class="p">:</span>
			<span class="n">_data</span> <span class="o">=</span> <span class="n">_density_based_sample</span><span class="p">(</span><span class="n">_data</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">max_points</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
	<span class="n">n_dots</span> <span class="o">=</span> <span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

	<span class="c1"># determine rasterized</span>
	<span class="k">if</span> <span class="n">rasterized</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">n_dots</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
			<span class="n">rasterized</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">rasterized</span> <span class="o">=</span> <span class="kc">False</span>

	<span class="c1"># auto size if user didn&#39;t provide one</span>
	<span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">_auto_size</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">n_dots</span><span class="p">)</span>

	<span class="c1"># default scatter options</span>
	<span class="n">_scatter_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span> <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;rasterized&quot;</span><span class="p">:</span> <span class="n">rasterized</span><span class="p">}</span>
	<span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one of color and hue can be provided&quot;</span><span class="p">)</span>
		<span class="n">_scatter_kws</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
	<span class="k">if</span> <span class="n">scatter_kws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">_scatter_kws</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scatter_kws</span><span class="p">)</span>

	<span class="c1"># deal with color</span>
	<span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;hue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_take_data_series</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hue</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
			<span class="n">colorbar_label</span> <span class="o">=</span> <span class="n">hue</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;hue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hue</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
			<span class="n">colorbar_label</span> <span class="o">=</span> <span class="n">hue</span><span class="o">.</span><span class="n">name</span>

		<span class="k">if</span> <span class="n">hue_norm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="c1"># get the smallest range that include &quot;hue_portion&quot; of data</span>
			<span class="c1"># hue_norm = tight_hue_range(_data[&quot;hue&quot;], hue_portion)</span>
			<span class="n">hue_norm</span><span class="o">=</span><span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="s2">&quot;hue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">hue_portion</span><span class="p">),</span><span class="n">_data</span><span class="p">[</span><span class="s2">&quot;hue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">hue_portion</span><span class="p">))</span>
		<span class="c1"># cnorm is the normalizer for color</span>
		<span class="n">cnorm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">hue_norm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">hue_norm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="c1"># from here, cmap become colormap object</span>
			<span class="n">cmap</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">))</span>
			<span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">ScalarMappable</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cmap can only be str or ScalarMappable, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">hue_norm</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="n">cnorm</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="n">colorbar_label</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

	<span class="c1"># deal with size</span>
	<span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_take_data_series</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="s2">&quot;size&quot;</span>

		<span class="k">if</span> <span class="n">size_norm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="c1"># get the smallest range that include &quot;size_portion&quot; of data</span>
			<span class="n">size_norm</span> <span class="o">=</span> <span class="n">tight_hue_range</span><span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">],</span> <span class="n">size_portion</span><span class="p">)</span>

			<span class="c1"># snorm is the normalizer for size</span>
			<span class="n">size_norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">size_norm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">size_norm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

		<span class="c1"># replace s with sizes</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">_scatter_kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">sizes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">sizes</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">s</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">size_norm</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="n">sizes</span> <span class="o">=</span> <span class="kc">None</span>

	<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
		<span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
		<span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
		<span class="n">data</span><span class="o">=</span><span class="n">_data</span><span class="p">,</span>
		<span class="n">hue</span><span class="o">=</span><span class="s2">&quot;hue&quot;</span><span class="p">,</span>
		<span class="n">palette</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
		<span class="n">hue_norm</span><span class="o">=</span><span class="n">cnorm</span><span class="p">,</span>
		<span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
		<span class="n">sizes</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span>
		<span class="n">size_norm</span><span class="o">=</span><span class="n">size_norm</span><span class="p">,</span>
		<span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
		<span class="o">**</span><span class="n">_scatter_kws</span><span class="p">,</span>
	<span class="p">)</span>

	<span class="k">if</span> <span class="n">text_anno</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_anno</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;text_anno&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_take_data_series</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">text_anno</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;text_anno&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text_anno</span>
		<span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">_data</span><span class="p">[</span><span class="s2">&quot;text_anno&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;text_anno&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_data</span><span class="p">[</span><span class="s2">&quot;text_anno&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">remove_unused_categories</span><span class="p">()</span>

		<span class="n">_text_anno_scatter</span><span class="p">(</span>
			<span class="n">data</span><span class="o">=</span><span class="n">_data</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;text_anno&quot;</span><span class="p">]],</span>
			<span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
			<span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
			<span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
			<span class="n">dodge_text</span><span class="o">=</span><span class="n">dodge_text</span><span class="p">,</span>
			<span class="n">dodge_kws</span><span class="o">=</span><span class="n">dodge_kws</span><span class="p">,</span>
			<span class="n">text_transform</span><span class="o">=</span><span class="n">text_transform</span><span class="p">,</span>
			<span class="n">anno_col</span><span class="o">=</span><span class="s2">&quot;text_anno&quot;</span><span class="p">,</span>
			<span class="n">text_kws</span><span class="o">=</span><span class="n">text_kws</span><span class="p">,</span>
			<span class="n">luminance</span><span class="o">=</span><span class="n">luminance</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="c1"># deal with outline</span>
	<span class="k">if</span> <span class="n">outline</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outline</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;outline&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_take_data_series</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outline</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">_data</span><span class="p">[</span><span class="s2">&quot;outline&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outline</span>
		<span class="n">_outline_kws</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="n">linewidth</span><span class="p">,</span>
			<span class="s2">&quot;palette&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
			<span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;lightgray&quot;</span><span class="p">,</span>
			<span class="s2">&quot;single_contour_pad&quot;</span><span class="p">:</span> <span class="n">outline_pad</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="n">outline_kws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">_outline_kws</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">outline_kws</span><span class="p">)</span>
		<span class="n">density_contour</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">_data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;outline&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">_outline_kws</span><span class="p">)</span>

	<span class="c1"># clean axis</span>
	<span class="k">if</span> <span class="n">axis_format</span> <span class="o">==</span> <span class="s2">&quot;tiny&quot;</span><span class="p">:</span>
		<span class="n">_make_tiny_axis_label</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">arrow_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">labelsize</span><span class="p">)</span>
	<span class="k">elif</span> <span class="p">(</span><span class="n">axis_format</span> <span class="o">==</span> <span class="s2">&quot;empty&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">axis_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
		<span class="n">despine</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[],</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">pass</span>

	<span class="n">return_axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="p">]</span>

	<span class="c1"># make color bar</span>
	<span class="k">if</span> <span class="n">colorbar</span> <span class="ow">and</span> <span class="p">(</span><span class="n">hue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
		<span class="c1"># small ax for colorbar</span>
		<span class="c1"># default_cbar_kws=dict(loc=&quot;upper left&quot;, borderpad=0,width=&quot;3%&quot;, height=&quot;20%&quot;) #bbox_to_anchor=(1,1)</span>
		<span class="k">if</span> <span class="n">cbar_kws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">cbar_kws</span><span class="o">=</span><span class="p">{}</span>
		<span class="c1"># for k in default_cbar_kws:</span>
		<span class="c1">#     if k not in cbar_kws:</span>
		<span class="c1">#         cbar_kws[k]=default_cbar_kws[k]</span>

		<span class="n">mm2inch</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">25.4</span>
		<span class="n">space</span><span class="o">=</span><span class="mi">0</span>
		<span class="n">legend_width</span> <span class="o">=</span> <span class="p">(</span>
			<span class="n">cbar_width</span> <span class="o">*</span> <span class="n">mm2inch</span> <span class="o">*</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">dpi</span> <span class="o">/</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span><span class="o">.</span><span class="n">width</span>
		<span class="p">)</span>  <span class="c1"># mm to px to fraction</span>
		<span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="n">space</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">labelpad</span> <span class="o">*</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">dpi</span> <span class="o">/</span> <span class="mi">72</span><span class="p">)</span> <span class="o">/</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span><span class="o">.</span><span class="n">width</span>
		<span class="c1"># labelpad unit is points</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">x1</span> <span class="o">+</span> <span class="n">pad</span>
		<span class="n">ax_legend</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span>
			<span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">legend_width</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">]</span>
		<span class="p">)</span>  <span class="c1"># left, bottom, width, height</span>
		<span class="c1"># print(&quot;test:&quot;,hue_norm)</span>
		<span class="c1"># cbar_kws.setdefault(&#39;vmin&#39;,hue_norm[0])</span>
		<span class="c1"># cbar_kws.setdefault(&#39;vmax&#39;,hue_norm[1])</span>
		<span class="n">cbar_kws</span><span class="p">[</span><span class="s1">&#39;vmin&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">hue_norm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">cbar_kws</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">hue_norm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="n">cbar</span> <span class="o">=</span> <span class="n">plot_cmap_legend</span><span class="p">(</span>
			<span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
			<span class="n">cax</span><span class="o">=</span><span class="n">ax_legend</span><span class="p">,</span>
			<span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
			<span class="n">label</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span>
			<span class="n">kws</span><span class="o">=</span><span class="n">cbar_kws</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">labelsize</span><span class="o">=</span><span class="n">labelsize</span><span class="p">,</span> 
			<span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span><span class="n">ticklabel_size</span><span class="o">=</span><span class="n">ticklabel_size</span><span class="p">,</span>
			<span class="p">)</span>
		<span class="n">return_axes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ax_legend</span><span class="p">,</span><span class="n">cbar</span><span class="p">])</span>

	<span class="c1"># make size bar</span>
	<span class="k">if</span> <span class="n">sizebar</span> <span class="ow">and</span> <span class="p">(</span><span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
		<span class="c1"># TODO plot dot size bar</span>
		<span class="k">pass</span>

	<span class="k">if</span> <span class="n">zoomxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">zoom_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">zoomxy</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">return_fig</span><span class="p">:</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">return_axes</span><span class="p">)),</span> <span class="n">_data</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span></div>


<div class="viewcode-block" id="plot_cluster">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.plot_cluster">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_cluster</span><span class="p">(</span>
	<span class="n">adata_path</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">coord_base</span><span class="o">=</span><span class="s1">&#39;tsne&#39;</span><span class="p">,</span><span class="n">cluster_col</span><span class="o">=</span><span class="s1">&#39;MajorType&#39;</span><span class="p">,</span>
	<span class="n">palette_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">coding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">id_marker</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
	<span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span><span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="n">ncol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">legend_fontsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
	<span class="n">legend_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">legend_title_fontsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
	<span class="n">marker_fontsize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">marker_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
	<span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">axis_format</span><span class="o">=</span><span class="s1">&#39;tiny&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
	<span class="n">text_kws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Plot cluster.</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	adata_path :</span>
<span class="sd">	ax :</span>
<span class="sd">	coord_base :</span>
<span class="sd">	cluster_col :</span>
<span class="sd">	palette_path :</span>
<span class="sd">	coding :</span>
<span class="sd">	output :</span>
<span class="sd">	show :</span>
<span class="sd">	figsize :</span>
<span class="sd">	sheet_name :</span>
<span class="sd">	ncol :</span>
<span class="sd">	fontsize :</span>
<span class="sd">	legend_fontsize : int</span>
<span class="sd">		legend fontsize, default 5</span>
<span class="sd">	legend_kws: dict</span>
<span class="sd">		kwargs passed to ax.legend</span>
<span class="sd">	legend_title_fontsize: int</span>
<span class="sd">		legend title fontsize, default 5</span>
<span class="sd">	marker_fontsize: int</span>
<span class="sd">		Marker fontsize, default 3</span>
<span class="sd">		if id_marker is True, and coding is True. legend marker will be a circle (or rectangle) with code</span>
<span class="sd">	linewidth : float</span>
<span class="sd">		Line width of the legend marker (circle or rectangle), default 0.5</span>
<span class="sd">	kwargs : dict</span>
<span class="sd">		set text_anno=None to plot clustering without text annotations,</span>
<span class="sd">		coding=True to plot clustering without code annotations,</span>
<span class="sd">		set show_legend=False to remove the legend</span>

<span class="sd">	Returns</span>
<span class="sd">	-------</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="kn">from</span><span class="w"> </span><span class="nn">pandas.api.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_categorical_dtype</span>
	<span class="k">if</span> <span class="n">coord_base</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;X_&quot;</span><span class="p">):</span>
		<span class="n">coord_base</span><span class="o">=</span><span class="n">coord_base</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;X_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">sheet_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">sheet_name</span><span class="o">=</span><span class="n">cluster_col</span>
	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adata_path</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
		<span class="n">adata</span><span class="o">=</span><span class="n">anndata</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">adata_path</span><span class="p">,</span><span class="n">backed</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">adata</span><span class="o">=</span><span class="n">adata_path</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">is_categorical_dtype</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cluster_col</span><span class="p">]):</span>
		<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cluster_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cluster_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">palette_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">palette_path</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
			<span class="n">colors</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">palette_path</span><span class="p">),</span><span class="n">sheet_name</span><span class="o">=</span><span class="n">sheet_name</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">Hex</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
			<span class="n">keys</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">colors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
			<span class="n">existed_vals</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cluster_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">existed_vals</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
					<span class="n">colors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span>
			<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existed_vals</span><span class="p">:</span>
					<span class="k">del</span> <span class="n">colors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">colors</span><span class="o">=</span><span class="n">palette_path</span>
		<span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">cluster_col</span> <span class="o">+</span> <span class="s1">&#39;_colors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cluster_col</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cluster_col</span><span class="si">}</span><span class="s1">_colors&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">:</span>
			<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="n">basis</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;X_</span><span class="si">{</span><span class="n">coord_base</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">cluster_col</span><span class="p">],</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="n">colors</span><span class="o">=</span><span class="p">{</span><span class="n">cluster</span><span class="p">:</span><span class="n">color</span> <span class="k">for</span> <span class="n">cluster</span><span class="p">,</span><span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cluster_col</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cluster_col</span><span class="si">}</span><span class="s1">_colors&#39;</span><span class="p">])}</span>

	<span class="n">hue</span><span class="o">=</span><span class="n">cluster_col</span>
	<span class="n">text_anno</span> <span class="o">=</span> <span class="n">cluster_col</span>
	<span class="n">text_kws</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">text_kws</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">text_kws</span>
	<span class="n">text_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;fontsize&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">)</span>
	<span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;hue&quot;</span><span class="p">,</span><span class="n">hue</span><span class="p">)</span>
	<span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;text_anno&quot;</span><span class="p">,</span> <span class="n">text_anno</span><span class="p">)</span>
	<span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;text_kws&quot;</span><span class="p">,</span> <span class="n">text_kws</span><span class="p">)</span>
	<span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;luminance&quot;</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">)</span>
	<span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;dodge_text&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
	<span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;axis_format&quot;</span><span class="p">,</span> <span class="n">axis_format</span><span class="p">)</span>
	<span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;show_legend&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
	<span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;marker_fontsize&quot;</span><span class="p">,</span> <span class="n">marker_fontsize</span><span class="p">)</span>
	<span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;marker_pad&quot;</span><span class="p">,</span> <span class="n">marker_pad</span><span class="p">)</span>
	<span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;linewidth&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="p">)</span>
	<span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
	<span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;coding&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">coding</span>
	<span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;id_marker&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">id_marker</span>
	<span class="n">legend_kws</span><span class="o">=</span><span class="p">{}</span> <span class="k">if</span> <span class="n">legend_kws</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">legend_kws</span>
	<span class="n">default_lgd_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
		<span class="n">fontsize</span><span class="o">=</span><span class="n">legend_fontsize</span><span class="p">,</span>
		<span class="n">title</span><span class="o">=</span><span class="n">cluster_col</span><span class="p">,</span><span class="n">title_fontsize</span><span class="o">=</span><span class="n">legend_title_fontsize</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">ncol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">default_lgd_kws</span><span class="p">[</span><span class="s1">&#39;ncol&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ncol</span>
	<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">default_lgd_kws</span><span class="p">:</span>
		<span class="n">legend_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">default_lgd_kws</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
	<span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;dodge_kws&quot;</span><span class="p">,</span> <span class="p">{</span>
			<span class="s2">&quot;arrowprops&quot;</span><span class="p">:</span> <span class="p">{</span>
				<span class="s2">&quot;arrowstyle&quot;</span><span class="p">:</span> <span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span>
				<span class="s2">&quot;fc&quot;</span><span class="p">:</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span>
				<span class="s2">&quot;ec&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
				<span class="s2">&quot;connectionstyle&quot;</span><span class="p">:</span> <span class="s2">&quot;angle,angleA=-90,angleB=180,rad=5&quot;</span><span class="p">,</span>
			<span class="p">},</span>
			<span class="s1">&#39;autoalign&#39;</span><span class="p">:</span> <span class="s1">&#39;xy&#39;</span><span class="p">})</span>
	<span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">categorical_scatter</span><span class="p">(</span>
		<span class="n">data</span><span class="o">=</span><span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cluster_col</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),],</span>
		<span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
		<span class="n">coord_base</span><span class="o">=</span><span class="n">coord_base</span><span class="p">,</span>
		<span class="n">palette</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span><span class="n">legend_kws</span><span class="o">=</span><span class="n">legend_kws</span><span class="p">,</span>
		<span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

	<span class="k">if</span> <span class="ow">not</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">output</span><span class="p">))</span> <span class="c1"># transparent=True,bbox_inches=&#39;tight&#39;,dpi=300</span>
	<span class="k">if</span> <span class="n">show</span><span class="p">:</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_gene">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.plot_gene">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_gene</span><span class="p">(</span>
	<span class="n">adata_path</span><span class="o">=</span><span class="s2">&quot;~/Projects/BG/adata/BG.gene-CGN.h5ad&quot;</span><span class="p">,</span><span class="n">obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="n">group_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">gene</span><span class="o">=</span><span class="s1">&#39;CADM1&#39;</span><span class="p">,</span><span class="n">query_str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="n">palette_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">hue_norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="n">cbar_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">extendfrac</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span><span class="n">axis_format</span><span class="o">=</span><span class="s2">&quot;tiny&quot;</span><span class="p">,</span><span class="n">scatter_kws</span><span class="o">=</span><span class="p">{},</span>
	<span class="n">obsm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">coord_base</span><span class="o">=</span><span class="s1">&#39;umap&#39;</span><span class="p">,</span><span class="n">normalize_per_cell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
	<span class="n">stripplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">hypo_score</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="n">clip_norm_value</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">min_cells</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;parula&#39;</span><span class="p">,</span><span class="n">figdir</span><span class="o">=</span><span class="s2">&quot;figures&quot;</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Plot gene expression in a given region or group on embedding of adata.</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	adata_path : str, optional</span>
<span class="sd">		_description_, by default &quot;~/Projects/BG/adata/BG.gene-CGN.h5ad&quot;</span>
<span class="sd">	group_col : str, optional</span>
<span class="sd">		_description_, for example: &#39;Region&#39;, by default None</span>
<span class="sd">	gene : str, optional</span>
<span class="sd">		_description_, by default &#39;CADM1&#39;</span>
<span class="sd">	query_str : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	title : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	palette_path : str, optional</span>
<span class="sd">		_description_, by default &quot;~/Projects/BG/obs/HMBA_color_palette.xlsx&quot;</span>
<span class="sd">	obsm : str, optional</span>
<span class="sd">		_description_, by default &quot;~/Projects/BG/clustering/100kb/annotated.adata.h5ad&quot;</span>
<span class="sd">	coord_base : str, optional</span>
<span class="sd">		_description_, by default &#39;umap&#39;</span>
<span class="sd">	normalize_per_cell : bool, optional</span>
<span class="sd">		_description_, by default True</span>
<span class="sd">	stripplot : bool, optional</span>
<span class="sd">		_description_, by default False</span>
<span class="sd">	clip_norm_value : int, optional</span>
<span class="sd">		_description_, by default 10</span>
<span class="sd">	min_cells : int, optional</span>
<span class="sd">		_description_, by default 3</span>
<span class="sd">	cmap: str, optional</span>
<span class="sd">		_description_, by default &#39;parula&#39;</span>
<span class="sd">	figdir : str, optional</span>
<span class="sd">		_description_, by default &quot;figures&quot;</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1"># sc.set_figure_params(dpi=100,dpi_save=300,frameon=False)</span>
	<span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">query_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">title</span><span class="o">=</span><span class="n">query_str</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">title</span><span class="o">=</span><span class="n">group_col</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">group_col</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">gene</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">figdir</span><span class="p">):</span>
		<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">figdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">raw_adata</span> <span class="o">=</span> <span class="n">anndata</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">adata_path</span><span class="p">),</span> <span class="n">backed</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
	<span class="n">adata</span> <span class="o">=</span> <span class="n">raw_adata</span><span class="p">[:,</span> <span class="n">gene</span><span class="p">]</span><span class="o">.</span><span class="n">to_memory</span><span class="p">()</span>
	<span class="n">raw_adata</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># close the file to save memory</span>
	<span class="k">if</span> <span class="n">normalize_per_cell</span><span class="p">:</span>
		<span class="n">adata</span> <span class="o">=</span> <span class="n">normalize_mc_by_cell</span><span class="p">(</span>
			<span class="n">use_adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span> <span class="n">normalize_per_cell</span><span class="o">=</span><span class="n">normalize_per_cell</span><span class="p">,</span>
			<span class="n">clip_norm_value</span><span class="o">=</span><span class="n">clip_norm_value</span><span class="p">,</span><span class="n">hypo_score</span><span class="o">=</span><span class="n">hypo_score</span><span class="p">)</span>
	<span class="n">is_open</span><span class="o">=</span><span class="kc">False</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">obsm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsm</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">obsm</span> <span class="o">=</span> <span class="n">anndata</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">obsm</span><span class="p">),</span><span class="n">backed</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
			<span class="n">is_open</span><span class="o">=</span><span class="kc">True</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsm</span><span class="p">,</span> <span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">),</span> <span class="s2">&quot;obsm should be an anndata object or a path to an h5ad file.&quot;</span>
		<span class="n">keep_cells</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">obsm</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
		<span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">keep_cells</span><span class="p">,</span> <span class="p">:]</span>
		<span class="n">adata</span><span class="o">.</span><span class="n">obsm</span> <span class="o">=</span> <span class="n">obsm</span><span class="p">[</span><span class="n">keep_cells</span><span class="p">]</span><span class="o">.</span><span class="n">obsm</span>
		<span class="n">cur_cols</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">obsm</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cur_cols</span><span class="p">:</span>
				<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">obsm</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">is_open</span><span class="p">:</span>
		<span class="n">obsm</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
			<span class="n">obs</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">obs</span><span class="p">),</span>
				<span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">obs</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">query_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query_str</span><span class="p">)</span>
	<span class="n">overlapped_cells</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
	<span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">overlapped_cells</span><span class="p">]</span>
	<span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">[</span><span class="n">overlapped_cells</span><span class="p">,:]</span> <span class="c1"># type: ignore</span>
	<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
	<span class="nb">print</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
	<span class="c1"># read color palette</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">group_col</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">palette_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">palette_path</span><span class="p">)):</span>
			<span class="n">palette_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">palette_path</span><span class="p">))</span>
			<span class="n">D</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">palette_path</span><span class="p">,</span>
							  <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">color_palette</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">Hex</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">color_palette</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="n">group_col</span><span class="p">,</span> \
				<span class="n">palette_path</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">group_col</span><span class="p">)[</span>
				<span class="n">palette_path</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">color_palette</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="c1"># plot gene on given cordinate base</span>
	<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
	<span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">figdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">gene</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">coord_base</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
	<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="n">coord_base</span><span class="p">,</span>
					<span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">gene</span><span class="p">],</span><span class="n">use_raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
					<span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="s1">&#39;p5&#39;</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="s1">&#39;p95&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
					<span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
	<span class="n">colorbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
	<span class="n">cur_pos</span><span class="o">=</span><span class="n">colorbar</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
	<span class="n">colorbar</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">cur_pos</span><span class="o">.</span><span class="n">x0</span><span class="p">,(</span><span class="mi">1</span><span class="o">-</span><span class="n">cur_pos</span><span class="o">.</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">cur_pos</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">cur_pos</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span>
	<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="c1"># transparent=True,bbox_inches=&#39;tight&#39;,dpi=300</span>

	<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">gene</span><span class="p">]</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">gene</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="c1"># print(hue_norm)</span>
	<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
	<span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">figdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">gene</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">coord_base</span><span class="si">}</span><span class="s2">1.pdf&quot;</span><span class="p">)</span>
	<span class="n">continuous_scatter</span><span class="p">(</span>
		<span class="n">data</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
		<span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
		<span class="n">hue_norm</span><span class="o">=</span><span class="n">hue_norm</span><span class="p">,</span>
		<span class="n">cbar_kws</span><span class="o">=</span><span class="n">cbar_kws</span><span class="p">,</span>
		<span class="n">hue</span><span class="o">=</span><span class="n">gene</span><span class="p">,</span><span class="n">axis_format</span><span class="o">=</span><span class="n">axis_format</span><span class="p">,</span>
		<span class="n">text_anno</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">coord_base</span><span class="o">=</span><span class="n">coord_base</span><span class="p">,</span><span class="o">**</span><span class="n">scatter_kws</span><span class="p">)</span>
	<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="c1"># transparent=True,bbox_inches=&#39;tight&#39;,dpi=300</span>
	
	<span class="k">if</span> <span class="ow">not</span> <span class="n">group_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">figdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">group_col</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">coord_base</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output</span><span class="p">):</span> <span class="c1"># plot embedding colored by group_col</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">color_palette</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">use_cells</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">color_palette</span><span class="o">.</span><span class="n">keys</span><span class="p">()))]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">use_cells</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
			<span class="n">plot_cluster</span><span class="p">(</span><span class="n">adata_path</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span><span class="n">coord_base</span><span class="o">=</span><span class="n">coord_base</span><span class="p">,</span>
				<span class="n">cluster_col</span><span class="o">=</span><span class="n">group_col</span><span class="p">,</span>
				<span class="n">coding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">palette_path</span><span class="o">=</span><span class="n">palette_path</span><span class="p">,</span><span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span><span class="n">text_anno</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

		<span class="c1"># boxplot</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
		<span class="n">data</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
		<span class="n">vc</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
		<span class="n">N</span><span class="o">=</span><span class="n">vc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">color_palette</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">keep_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">color_palette</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">vc</span><span class="p">[</span><span class="n">vc</span> <span class="o">&gt;=</span> <span class="n">min_cells</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">keep_groups</span><span class="p">)]</span>
		<span class="n">vc</span> <span class="o">=</span> <span class="n">vc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
		<span class="n">order</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_col</span><span class="p">)[</span><span class="n">gene</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
		<span class="n">width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">N</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">stripplot</span><span class="p">:</span>
			<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
							<span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">group_col</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">gene</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">color_palette</span><span class="p">,</span> \
							<span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="c1"># ax = sns.boxplot(data=data, x=group_col, y=gene, palette=color_palette, ax=ax,  # hue=group_col,</span>
		<span class="c1"># 				fliersize=0.5, notch=False, showfliers=False, saturation=0.6, order=order)</span>
		<span class="c1"># boxplot are incorrect for some cases when there are many 0, median and lower quartile are often at zero; use violinplot in stead.</span>
		<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">group_col</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">gene</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">color_palette</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>  <span class="c1"># hue=group_col,</span>
                <span class="n">saturation</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span><span class="n">density_norm</span><span class="o">=</span><span class="s1">&#39;width&#39;</span><span class="p">,</span><span class="n">cut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">bw_adjust</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
		<span class="c1"># ax=sns.swarmplot(data=data,palette=color_palette,\</span>
		<span class="c1">#                   edgecolor=&#39;white&#39;,x=group_col,y=gene,\</span>
		<span class="c1">#                   order=order)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">ax</span><span class="o">.</span><span class="n">set_ybound</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
		<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">vc</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">order</span><span class="p">])</span>
		<span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
		<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
		<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_majorticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=-</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">figdir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">gene</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">group_col</span><span class="si">}</span><span class="s2">.boxplot.pdf&quot;</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">adata</span></div>


<div class="viewcode-block" id="plot_genes">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.plot_genes">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_genes</span><span class="p">(</span>
	<span class="n">adata_path</span><span class="o">=</span><span class="s2">&quot;/home/x-wding2/Projects/BICAN/adata/HMBA_v2/HMBA.Group.downsample_1500.h5ad&quot;</span><span class="p">,</span>
	<span class="n">query_str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="n">obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1">#&quot;~/Projects/BG/clustering/100kb/annotations.tsv&quot;,</span>
	<span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;Subclass&#39;</span><span class="p">,</span>
	<span class="n">parent_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="n">modality</span><span class="o">=</span><span class="s1">&#39;RNA&#39;</span><span class="p">,</span> <span class="c1"># mc or RNA</span>
	<span class="n">use_raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># True for RNA</span>
	<span class="n">expression_cutoff</span><span class="o">=</span><span class="s1">&#39;p5&#39;</span><span class="p">,</span> <span class="c1"># for RNA, could be int, median, mean of p5, p95 and so on</span>
	<span class="n">genes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="n">cell_type_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="n">gene_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="n">row_cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
	<span class="n">col_cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
	<span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greens_r&#39;</span><span class="p">,</span>
	<span class="n">group_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
	<span class="n">parent_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
	<span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
	<span class="n">palette_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="c1">#&quot;/home/x-wding2/Projects/BICAN/adata/HMBA_v2/HMBA_color_palette.xlsx&quot;</span>
	<span class="n">legend_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">extendfrac</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">extend</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean mCG&#39;</span><span class="p">),</span>
	<span class="n">normalize_per_cell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
	<span class="n">clip_norm_value</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
	<span class="n">hypo_score</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
	<span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span>
	<span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
	<span class="n">plot_kws</span><span class="o">=</span><span class="p">{},</span><span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
	<span class="n">outname</span><span class="o">=</span><span class="s2">&quot;test.pdf&quot;</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	_summary_</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	couldbeint : _type_</span>
<span class="sd">		_description_</span>
<span class="sd">	median : _type_</span>
<span class="sd">		_description_</span>
<span class="sd">	meanofp5 : _type_</span>
<span class="sd">		_description_</span>
<span class="sd">	adata_path : str, optional</span>
<span class="sd">		_description_, by default &quot;/home/x-wding2/Projects/BICAN/adata/HMBA_v2/HMBA.Group.downsample_1500.h5ad&quot;</span>
<span class="sd">	query_str : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	obs : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	group_col : str, optional</span>
<span class="sd">		_description_, by default &#39;Subclass&#39;</span>
<span class="sd">	parent_col : str, optional</span>
<span class="sd">		_description_, by default &#39;Neighborhood&#39;</span>
<span class="sd">	modality : str, optional</span>
<span class="sd">		_description_, by default &#39;RNA&#39;</span>
<span class="sd">	p95andsoongenes : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	cell_type_order : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	gene_order : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	row_cluster : bool, optional</span>
<span class="sd">		_description_, by default False</span>
<span class="sd">	col_cluster : bool, optional</span>
<span class="sd">		_description_, by default False</span>
<span class="sd">	cmap : str, optional</span>
<span class="sd">		_description_, by default &#39;Greens_r&#39;</span>
<span class="sd">	group_legend : bool, optional</span>
<span class="sd">		_description_, by default False</span>
<span class="sd">	parent_legend : bool, optional</span>
<span class="sd">		_description_, by default False</span>
<span class="sd">	title : str, optional</span>
<span class="sd">		_description_, by default &#39;test&#39;</span>
<span class="sd">	palette_path : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	obsm : _type_, optional</span>
<span class="sd">		_description_, by default None</span>
<span class="sd">	normalize_per_cell : bool, optional</span>
<span class="sd">		_description_, by default True</span>
<span class="sd">	clip_norm_value : int, optional</span>
<span class="sd">		_description_, by default 10</span>
<span class="sd">	hypo_score : bool, optional</span>
<span class="sd">		_description_, by default False</span>
<span class="sd">	figsize : tuple, optional</span>
<span class="sd">		_description_, by default (10, 3.5)</span>
<span class="sd">	cmap : str, optional</span>
<span class="sd">		_description_, by default &#39;Greens_r&#39;</span>
<span class="sd">	marker : str, optional</span>
<span class="sd">		_description_, by default &#39;o&#39;</span>
<span class="sd">	plot_kws : dict, optional</span>
<span class="sd">		_description_, by default {}</span>
<span class="sd">	outname : str, optional</span>
<span class="sd">		_description_, by default &quot;test.pdf&quot;</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="kn">from</span><span class="w"> </span><span class="nn">PyComplexHeatmap</span><span class="w"> </span><span class="kn">import</span> <span class="n">HeatmapAnnotation</span><span class="p">,</span><span class="n">anno_label</span><span class="p">,</span><span class="n">anno_simple</span><span class="p">,</span><span class="n">DotClustermapPlotter</span>
	<span class="k">assert</span> <span class="ow">not</span> <span class="n">genes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Please provide genes to plot.&quot;</span>
	<span class="c1"># adata could be single cell level or pseudobulk level (adata.layers[&#39;frac&#39;] should be existed)</span>
	<span class="n">raw_adata</span> <span class="o">=</span> <span class="n">anndata</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">adata_path</span><span class="p">),</span> <span class="n">backed</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

	<span class="n">all_vars</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">raw_adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
	<span class="n">keep_genes</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_vars</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">genes</span><span class="p">))</span> <span class="c1"># keep_genes=[g for g in all_vars if g in genes]</span>
	<span class="n">error_genes</span><span class="o">=</span><span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">genes</span> <span class="k">if</span> <span class="n">g</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep_genes</span><span class="p">]</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_genes</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
		<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;genes not found in adata: </span><span class="si">{</span><span class="n">error_genes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
	<span class="n">adata</span> <span class="o">=</span> <span class="n">raw_adata</span><span class="p">[:,</span> <span class="n">keep_genes</span><span class="p">]</span><span class="o">.</span><span class="n">to_memory</span><span class="p">()</span> <span class="c1"># type: ignore</span>
	<span class="k">if</span> <span class="n">use_raw</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">adata</span><span class="o">.</span><span class="n">raw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">adata_raw</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">raw</span><span class="p">[:,</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span><span class="o">.</span><span class="n">to_adata</span><span class="p">()</span>
		<span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">=</span><span class="n">adata_raw</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># type: ignore</span>
		<span class="k">del</span> <span class="n">adata_raw</span>
	<span class="n">raw_adata</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># close the file to save memory</span>

	<span class="k">if</span> <span class="ow">not</span> <span class="n">obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
			<span class="n">obs</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">obs</span><span class="p">),</span>
				<span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">obs</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">query_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query_str</span><span class="p">)</span>
	<span class="n">overlapped_cells</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
	<span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">overlapped_cells</span><span class="p">]</span>
	<span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">[</span><span class="n">overlapped_cells</span><span class="p">,:]</span> <span class="c1"># type: ignore</span>
	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_col</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
		<span class="n">group_col1</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_col</span><span class="p">)</span>
		<span class="n">obs</span><span class="p">[</span><span class="n">group_col1</span><span class="p">]</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="s1">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">group_col</span><span class="o">=</span><span class="n">group_col1</span>
	<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">query_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">title</span><span class="o">=</span><span class="n">query_str</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">title</span><span class="o">=</span><span class="n">group_col</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">group_col</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">genes</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">parent_col</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">parent_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
		<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">parent_col</span><span class="p">]</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span><span class="n">parent_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
			
	<span class="k">if</span> <span class="n">modality</span><span class="o">!=</span><span class="s1">&#39;RNA&#39;</span> <span class="ow">and</span> <span class="n">normalize_per_cell</span><span class="p">:</span>
		<span class="n">adata</span> <span class="o">=</span> <span class="n">normalize_mc_by_cell</span><span class="p">(</span>
			<span class="n">use_adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span> <span class="n">normalize_per_cell</span><span class="o">=</span><span class="n">normalize_per_cell</span><span class="p">,</span>
			<span class="n">clip_norm_value</span><span class="o">=</span><span class="n">clip_norm_value</span><span class="p">,</span><span class="n">hypo_score</span><span class="o">=</span><span class="n">hypo_score</span><span class="p">)</span>
	<span class="nb">print</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

	<span class="c1"># read color palette</span>
	<span class="n">color_palette</span><span class="o">=</span><span class="p">{}</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">palette_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">palette_path</span><span class="p">)):</span>
			<span class="n">palette_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">palette_path</span><span class="p">))</span>
			<span class="n">D</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">palette_path</span><span class="p">,</span>
							<span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">group_col</span> <span class="ow">in</span> <span class="n">D</span><span class="p">:</span>
				<span class="n">color_palette</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">Hex</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">assert</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">group_col</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group_col</span><span class="si">}</span><span class="s2"> not found in the palette file.&quot;</span>
				<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">group_col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">):</span>
					<span class="k">assert</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">D</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> not found in the palette file.&quot;</span>
					<span class="n">color_palette</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">Hex</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">parent_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">color_palette</span><span class="p">[</span><span class="n">parent_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">parent_col</span><span class="p">]</span><span class="o">.</span><span class="n">Hex</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">color_palette</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="n">group_col</span><span class="p">,</span> \
				<span class="n">palette_path</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">group_col</span><span class="p">)[</span>
				<span class="n">palette_path</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
			<span class="n">color_palette</span><span class="p">[</span><span class="n">parent_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="n">parent_col</span><span class="p">,</span> \
				<span class="n">palette_path</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">parent_col</span><span class="p">)[</span>
				<span class="n">palette_path</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">color_palette</span> <span class="o">=</span> <span class="kc">None</span>

	<span class="n">data</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span> <span class="c1"># rows are cells or cell types, columns are genes</span>
	<span class="k">if</span> <span class="n">modality</span><span class="o">==</span><span class="s1">&#39;RNA&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expression_cutoff</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">expression_cutoff</span><span class="o">==</span><span class="s1">&#39;median&#39;</span><span class="p">:</span>
			<span class="n">cutoff</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
		<span class="k">elif</span> <span class="n">expression_cutoff</span><span class="o">==</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span>
			<span class="n">cutoff</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span> <span class="c1"># quantile, such as p5,p95</span>
			<span class="n">f</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">expression_cutoff</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
			<span class="n">cutoff</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">f</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
		<span class="n">expression_cutoff</span><span class="o">=</span><span class="n">cutoff</span>
			
	<span class="n">data</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">parent_col</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">parent_col</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
		<span class="n">group2parent</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="n">group_col</span><span class="p">,</span><span class="n">parent_col</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">group_col</span><span class="p">)[</span><span class="n">parent_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
	<span class="n">plot_data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_col</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
	<span class="n">plot_data</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">group_col</span><span class="p">,</span><span class="s1">&#39;Gene&#39;</span><span class="p">,</span><span class="s1">&#39;Mean&#39;</span><span class="p">]</span>
	<span class="k">if</span> <span class="s1">&#39;frac&#39;</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
		<span class="n">D</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">to_df</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="s1">&#39;frac&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">modality</span><span class="o">!=</span><span class="s1">&#39;RNA&#39;</span><span class="p">:</span> <span class="c1"># methylation, cutoff = 1</span>
			<span class="k">assert</span> <span class="n">normalize_per_cell</span><span class="o">==</span><span class="kc">True</span><span class="p">,</span><span class="s2">&quot;Normalized methylation fraction is required&quot;</span>
			<span class="n">hypo_frac</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_col</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># fraction of cells showing hypomethylation for the corresponding genes</span>
			<span class="n">D</span><span class="o">=</span><span class="n">hypo_frac</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span> <span class="c1"># for RNA</span>
			<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using expression cutoff: </span><span class="si">{</span><span class="n">expression_cutoff</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="n">frac</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_col</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">&gt;</span><span class="n">expression_cutoff</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># raw count &gt; expression_cutoff means the gene is expressed</span>
			<span class="n">D</span><span class="o">=</span><span class="n">frac</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
	<span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;frac&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="n">group_col</span><span class="p">,</span><span class="s1">&#39;Gene&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
	<span class="c1"># plot_data</span>

	<span class="n">df_cols</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())),</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">group_col</span><span class="p">])</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">parent_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">df_cols</span><span class="p">[</span><span class="n">parent_col</span><span class="p">]</span><span class="o">=</span><span class="n">df_cols</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">group2parent</span><span class="p">)</span>
		<span class="n">df_cols</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">parent_col</span><span class="p">,</span><span class="n">group_col</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">df_cols</span><span class="o">.</span><span class="n">index</span><span class="o">=</span><span class="n">df_cols</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">cell_type_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">rows</span><span class="o">=</span><span class="p">[</span><span class="n">ct</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">cell_type_order</span> <span class="k">if</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">df_cols</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
		<span class="n">df_cols</span><span class="o">=</span><span class="n">df_cols</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span>
	<span class="n">col_ha_dict</span><span class="o">=</span><span class="p">{}</span>
	<span class="k">if</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">group_col</span><span class="p">:</span>
		<span class="n">individual_groups</span><span class="o">=</span><span class="n">group_col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">ig</span> <span class="ow">in</span> <span class="n">individual_groups</span><span class="p">:</span>
			<span class="n">df_cols</span><span class="p">[</span><span class="n">ig</span><span class="p">]</span><span class="o">=</span><span class="n">df_cols</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)[</span><span class="n">individual_groups</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ig</span><span class="p">)])</span>
			<span class="n">group_colors</span><span class="o">=</span><span class="p">{}</span>
			<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_cols</span><span class="p">[</span><span class="n">ig</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
				<span class="n">group_colors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">color_palette</span><span class="p">[</span><span class="n">ig</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
			<span class="n">col_ha_dict</span><span class="p">[</span><span class="n">ig</span><span class="p">]</span><span class="o">=</span><span class="n">anno_simple</span><span class="p">(</span><span class="n">df_cols</span><span class="p">[</span><span class="n">ig</span><span class="p">],</span><span class="n">colors</span><span class="o">=</span><span class="n">group_colors</span><span class="p">,</span>
								<span class="n">add_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="n">group_legend</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">ig</span><span class="p">)</span>
	<span class="n">df_cols</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="c1"># df_cols.head()</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">parent_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">parent_colors</span><span class="o">=</span><span class="p">{}</span>
		<span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">transpose</span> <span class="k">else</span> <span class="mi">0</span> <span class="c1"># 1 for vertical (col annotation), 0 for horizontal</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_cols</span><span class="p">[</span><span class="n">parent_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
			<span class="n">parent_colors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">color_palette</span><span class="p">[</span><span class="n">parent_col</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
		<span class="k">if</span> <span class="s1">&#39;+&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_col</span><span class="p">:</span>
			<span class="n">group_colors</span><span class="o">=</span><span class="p">{}</span>
			<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_cols</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
				<span class="n">group_colors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">color_palette</span><span class="p">[</span><span class="n">group_col</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
			<span class="n">col_ha</span><span class="o">=</span><span class="n">HeatmapAnnotation</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
				<span class="n">label</span><span class="o">=</span><span class="n">anno_label</span><span class="p">(</span><span class="n">df_cols</span><span class="p">[</span><span class="n">group_col</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="n">group_colors</span><span class="p">,</span><span class="n">merge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
								<span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">arrowprops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
				<span class="n">group</span><span class="o">=</span><span class="n">anno_simple</span><span class="p">(</span><span class="n">df_cols</span><span class="p">[</span><span class="n">group_col</span><span class="p">],</span><span class="n">colors</span><span class="o">=</span><span class="n">group_colors</span><span class="p">,</span>
									<span class="n">add_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="n">group_legend</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">group_col</span><span class="p">),</span> 
				<span class="n">parent</span><span class="o">=</span><span class="n">anno_simple</span><span class="p">(</span><span class="n">df_cols</span><span class="p">[</span><span class="n">parent_col</span><span class="p">],</span><span class="n">colors</span><span class="o">=</span><span class="n">parent_colors</span><span class="p">,</span>
									<span class="n">add_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="n">parent_legend</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">parent_col</span><span class="p">),</span> 
			<span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">col_ha_dict</span><span class="p">[</span><span class="n">parent_col</span><span class="p">]</span><span class="o">=</span><span class="n">anno_simple</span><span class="p">(</span><span class="n">df_cols</span><span class="p">[</span><span class="n">parent_col</span><span class="p">],</span><span class="n">colors</span><span class="o">=</span><span class="n">parent_colors</span><span class="p">,</span>
									<span class="n">add_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="n">parent_legend</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">parent_col</span><span class="p">)</span>
			<span class="n">col_ha</span> <span class="o">=</span> <span class="n">HeatmapAnnotation</span><span class="p">(</span><span class="o">**</span><span class="n">col_ha_dict</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
									<span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">colnames</span><span class="o">=</span><span class="kc">False</span>
		
	<span class="k">else</span><span class="p">:</span>
		<span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">transpose</span> <span class="k">else</span> <span class="mi">0</span> <span class="c1"># 1 for vertical (col annotation), 0 for horizontal</span>
		<span class="k">if</span> <span class="s1">&#39;+&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_col</span><span class="p">:</span>
			<span class="n">group_colors</span><span class="o">=</span><span class="p">{}</span>
			<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_cols</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
				<span class="n">group_colors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">color_palette</span><span class="p">[</span><span class="n">group_col</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
			<span class="n">col_ha</span><span class="o">=</span><span class="n">HeatmapAnnotation</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
				<span class="n">group</span><span class="o">=</span><span class="n">anno_simple</span><span class="p">(</span><span class="n">df_cols</span><span class="p">[</span><span class="n">group_col</span><span class="p">],</span><span class="n">colors</span><span class="o">=</span><span class="n">group_colors</span><span class="p">,</span>
									<span class="n">add_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="n">group_legend</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">group_col</span><span class="p">),</span> 
			<span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">col_ha</span> <span class="o">=</span> <span class="n">HeatmapAnnotation</span><span class="p">(</span><span class="o">**</span><span class="n">col_ha_dict</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
									<span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">colnames</span><span class="o">=</span><span class="kc">True</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">transpose</span><span class="p">:</span>
		<span class="n">top_annotation</span><span class="o">=</span><span class="n">col_ha</span>
		<span class="n">left_annotation</span><span class="o">=</span><span class="kc">None</span>
		<span class="n">x</span><span class="o">=</span><span class="n">group_col</span>
		<span class="n">y</span><span class="o">=</span><span class="s1">&#39;Gene&#39;</span>
		<span class="n">x_order</span><span class="o">=</span><span class="n">df_cols</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
		<span class="n">y_order</span><span class="o">=</span><span class="n">gene_order</span>
		<span class="n">show_colnames</span><span class="o">=</span><span class="n">colnames</span>
		<span class="n">show_rownames</span><span class="o">=</span><span class="kc">True</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">top_annotation</span><span class="o">=</span><span class="kc">None</span>
		<span class="n">left_annotation</span><span class="o">=</span><span class="n">col_ha</span>
		<span class="n">y</span><span class="o">=</span><span class="n">group_col</span>
		<span class="n">x</span><span class="o">=</span><span class="s1">&#39;Gene&#39;</span>
		<span class="n">y_order</span><span class="o">=</span><span class="n">df_cols</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
		<span class="n">x_order</span><span class="o">=</span><span class="n">gene_order</span>
		<span class="n">show_rownames</span><span class="o">=</span><span class="n">colnames</span>
		<span class="n">show_colnames</span><span class="o">=</span><span class="kc">True</span>

	<span class="n">default_plot_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
		<span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span><span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">legend_gap</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">dot_legend_marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span><span class="n">cmap_legend_kws</span><span class="o">=</span><span class="n">legend_kws</span><span class="p">,</span>
		<span class="n">row_cluster</span><span class="o">=</span><span class="n">row_cluster</span><span class="p">,</span><span class="n">col_cluster</span><span class="o">=</span><span class="n">col_cluster</span><span class="p">,</span>
		<span class="n">row_cluster_method</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">,</span><span class="n">row_cluster_metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span>
		<span class="n">col_cluster_method</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">,</span><span class="n">col_cluster_metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span>
		<span class="n">col_names_side</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="n">row_names_side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
		<span class="n">show_rownames</span><span class="o">=</span><span class="n">show_rownames</span><span class="p">,</span><span class="n">show_colnames</span><span class="o">=</span><span class="n">show_colnames</span><span class="p">,</span><span class="n">row_dendrogram</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
		<span class="c1"># vmin=0,vmax=1.5,</span>
		<span class="n">xticklabels_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;labelrotation&#39;</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span> <span class="s1">&#39;labelcolor&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="s1">&#39;labelsize&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;top&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">},</span>
		<span class="n">yticklabels_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;labelcolor&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="s1">&#39;labelsize&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;left&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">},</span>
		<span class="n">spines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">default_plot_kws</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_kws</span><span class="p">:</span>
			<span class="n">plot_kws</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">default_plot_kws</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
			
	<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
	<span class="n">cm1</span> <span class="o">=</span> <span class="n">DotClustermapPlotter</span><span class="p">(</span>
		<span class="n">data</span><span class="o">=</span><span class="n">plot_data</span><span class="p">,</span> <span class="n">top_annotation</span><span class="o">=</span><span class="n">top_annotation</span><span class="p">,</span><span class="n">left_annotation</span><span class="o">=</span><span class="n">left_annotation</span><span class="p">,</span>
		<span class="n">x_order</span><span class="o">=</span><span class="n">x_order</span><span class="p">,</span><span class="n">y_order</span><span class="o">=</span><span class="n">y_order</span><span class="p">,</span>
		<span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="s1">&#39;frac&#39;</span><span class="p">,</span>
		<span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="o">**</span><span class="n">plot_kws</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">cm1</span><span class="o">.</span><span class="n">heatmap_axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
		<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">outname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">outname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">outname</span><span class="p">))</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
	<span class="k">return</span> <span class="n">plot_data</span><span class="p">,</span><span class="n">df_cols</span><span class="p">,</span><span class="n">cm1</span></div>


<div class="viewcode-block" id="get_genes_mean_frac">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.get_genes_mean_frac">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_genes_mean_frac</span><span class="p">(</span>
		<span class="n">adata</span><span class="p">,</span><span class="n">obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;Subclass&#39;</span><span class="p">,</span><span class="n">modality</span><span class="o">=</span><span class="s1">&#39;RNA&#39;</span><span class="p">,</span><span class="n">layer</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
		<span class="n">use_raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">expression_cutoff</span><span class="o">=</span><span class="s1">&#39;p5&#39;</span><span class="p">,</span> <span class="n">genes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">normalize_per_cell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">clip_norm_value</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">hypo_score</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
		<span class="p">):</span>
	<span class="k">assert</span> <span class="ow">not</span> <span class="n">genes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Please provide genes to plot.&quot;</span>
	<span class="c1"># adata could be single cell level or pseudobulk level (adata.layers[&#39;frac&#39;] should be existed)</span>
	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
		<span class="n">adata</span><span class="o">=</span><span class="n">anndata</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">adata</span><span class="p">),</span> <span class="n">backed</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
	<span class="n">all_vars</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
	<span class="n">keep_genes</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_vars</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">genes</span><span class="p">))</span> <span class="c1"># keep_genes=[g for g in all_vars if g in genes]</span>
	<span class="n">error_genes</span><span class="o">=</span><span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">genes</span> <span class="k">if</span> <span class="n">g</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep_genes</span><span class="p">]</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_genes</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
		<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;genes not found in adata: </span><span class="si">{</span><span class="n">error_genes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
	<span class="n">use_adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[:,</span> <span class="n">keep_genes</span><span class="p">]</span><span class="o">.</span><span class="n">to_memory</span><span class="p">()</span> <span class="c1"># type: ignore</span>
	<span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">isbacked</span><span class="p">:</span>
		<span class="n">adata</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># close the file to save memory</span>
	<span class="k">if</span> <span class="s1">&#39;mean&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">use_adata</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span> <span class="c1">#raw count of single cell level adata</span>
		<span class="c1"># calculate mean and frac for each gene from single cell data</span>
		<span class="k">if</span> <span class="n">use_raw</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">use_adata</span><span class="o">.</span><span class="n">raw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="c1"># use_adata.X=use_adata.raw.X.copy()</span>
			<span class="n">use_adata_raw</span><span class="o">=</span><span class="n">use_adata</span><span class="o">.</span><span class="n">raw</span><span class="p">[:,</span><span class="n">use_adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span><span class="o">.</span><span class="n">to_adata</span><span class="p">()</span>
			<span class="n">use_adata</span><span class="o">.</span><span class="n">X</span><span class="o">=</span><span class="n">use_adata_raw</span><span class="p">[</span><span class="n">use_adata</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span><span class="n">use_adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># type: ignore</span>
			<span class="k">del</span> <span class="n">use_adata_raw</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
				<span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tsv&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obs</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;,&#39;</span>
				<span class="n">obs</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">obs</span><span class="p">),</span>
					<span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span> <span class="s2">&quot;obs should be a dataframe or a path to a csv/tsv file.&quot;</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">obs</span><span class="o">=</span><span class="n">use_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="n">overlapped_cells</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">use_adata</span><span class="o">.</span><span class="n">obs_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
		<span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">overlapped_cells</span><span class="p">]</span>
		<span class="n">use_adata</span><span class="o">=</span><span class="n">use_adata</span><span class="p">[</span><span class="n">overlapped_cells</span><span class="p">,:]</span> <span class="c1"># type: ignore</span>
			
		<span class="k">if</span> <span class="n">modality</span><span class="o">!=</span><span class="s1">&#39;RNA&#39;</span> <span class="ow">and</span> <span class="n">normalize_per_cell</span><span class="p">:</span>
			<span class="n">use_adata</span> <span class="o">=</span> <span class="n">normalize_mc_by_cell</span><span class="p">(</span>
				<span class="n">use_adata</span><span class="o">=</span><span class="n">use_adata</span><span class="p">,</span> <span class="n">normalize_per_cell</span><span class="o">=</span><span class="n">normalize_per_cell</span><span class="p">,</span>
				<span class="n">clip_norm_value</span><span class="o">=</span><span class="n">clip_norm_value</span><span class="p">,</span><span class="n">hypo_score</span><span class="o">=</span><span class="n">hypo_score</span><span class="p">)</span>

		<span class="n">data</span><span class="o">=</span><span class="n">use_adata</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span> <span class="c1"># rows are cells or cell types, columns are genes</span>
		<span class="k">if</span> <span class="n">modality</span><span class="o">==</span><span class="s1">&#39;RNA&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expression_cutoff</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">expression_cutoff</span><span class="o">==</span><span class="s1">&#39;median&#39;</span><span class="p">:</span>
				<span class="n">cutoff</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
			<span class="k">elif</span> <span class="n">expression_cutoff</span><span class="o">==</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span>
				<span class="n">cutoff</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
			<span class="k">else</span><span class="p">:</span> <span class="c1"># quantile, such as p5,p95</span>
				<span class="n">f</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">expression_cutoff</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
				<span class="n">cutoff</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">f</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
			<span class="n">expression_cutoff</span><span class="o">=</span><span class="n">cutoff</span>
		
		<span class="n">data</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="c1"># type: ignore</span>
		<span class="n">plot_data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_col</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
		<span class="n">plot_data</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">group_col</span><span class="p">,</span><span class="s1">&#39;Gene&#39;</span><span class="p">,</span><span class="s1">&#39;Mean&#39;</span><span class="p">]</span>
		<span class="k">if</span> <span class="s1">&#39;frac&#39;</span> <span class="ow">in</span> <span class="n">use_adata</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
			<span class="n">D</span><span class="o">=</span><span class="n">use_adata</span><span class="o">.</span><span class="n">to_df</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="s1">&#39;frac&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">modality</span><span class="o">!=</span><span class="s1">&#39;RNA&#39;</span><span class="p">:</span> <span class="c1"># methylation, cutoff = 1</span>
				<span class="k">assert</span> <span class="n">normalize_per_cell</span><span class="o">==</span><span class="kc">True</span><span class="p">,</span><span class="s2">&quot;Normalized methylation fraction is required&quot;</span>
				<span class="n">hypo_frac</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_col</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># fraction of cells showing hypomethylation for the corresponding genes</span>
				<span class="n">D</span><span class="o">=</span><span class="n">hypo_frac</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
			<span class="k">else</span><span class="p">:</span> <span class="c1"># for RNA</span>
				<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using expression cutoff: </span><span class="si">{</span><span class="n">expression_cutoff</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="n">frac</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_col</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">&gt;</span><span class="n">expression_cutoff</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># raw count &gt; expression_cutoff means the gene is expressed</span>
				<span class="n">D</span><span class="o">=</span><span class="n">frac</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
		<span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;frac&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="n">group_col</span><span class="p">,</span><span class="s1">&#39;Gene&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">plot_data</span><span class="o">=</span><span class="n">use_adata</span><span class="o">.</span><span class="n">to_df</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
		<span class="n">plot_data</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">group_col</span><span class="p">,</span><span class="s1">&#39;Gene&#39;</span><span class="p">,</span><span class="s1">&#39;Mean&#39;</span><span class="p">]</span>
		<span class="n">D</span><span class="o">=</span><span class="n">use_adata</span><span class="o">.</span><span class="n">to_df</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="s1">&#39;frac&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
		<span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;frac&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="n">group_col</span><span class="p">,</span><span class="s1">&#39;Gene&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">plot_data</span></div>


<div class="viewcode-block" id="interactive_dotHeatmap">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.interactive_dotHeatmap">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">interactive_dotHeatmap</span><span class="p">(</span>
		<span class="n">adata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">genes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;Subclass&#39;</span><span class="p">,</span>
		<span class="n">modality</span><span class="o">=</span><span class="s2">&quot;RNA&quot;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">use_raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
		<span class="n">expression_cutoff</span><span class="o">=</span><span class="s1">&#39;p5&#39;</span><span class="p">,</span><span class="n">normalize_per_cell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
		<span class="n">clip_norm_value</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
		<span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span><span class="n">gene_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;greens&#39;</span><span class="p">,</span>
		<span class="n">vmin</span><span class="o">=</span><span class="s1">&#39;p1&#39;</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="s1">&#39;p99&#39;</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
		<span class="n">reversescale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">size_min</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">size_max</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
		<span class="n">renderer</span><span class="o">=</span><span class="s2">&quot;notebook&quot;</span>
		<span class="p">):</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">renderer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">pio</span><span class="o">.</span><span class="n">renderers</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">renderer</span>
	<span class="n">plot_data</span><span class="o">=</span><span class="n">get_genes_mean_frac</span><span class="p">(</span>
		<span class="n">adata</span><span class="p">,</span><span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span><span class="n">group_col</span><span class="o">=</span><span class="n">group_col</span><span class="p">,</span><span class="n">modality</span><span class="o">=</span><span class="n">modality</span><span class="p">,</span>
		<span class="n">use_raw</span><span class="o">=</span><span class="n">use_raw</span><span class="p">,</span><span class="n">expression_cutoff</span><span class="o">=</span><span class="n">expression_cutoff</span><span class="p">,</span> <span class="n">genes</span><span class="o">=</span><span class="n">genes</span><span class="p">,</span>
		<span class="n">normalize_per_cell</span><span class="o">=</span><span class="n">normalize_per_cell</span><span class="p">,</span>
		<span class="n">clip_norm_value</span><span class="o">=</span><span class="n">clip_norm_value</span><span class="p">,</span><span class="n">hypo_score</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
		<span class="p">)</span> <span class="c1"># columns: [group_col,&#39;Gene&#39;,&#39;Mean&#39;,&#39;frac&#39;]</span>
	<span class="c1"># Build a Plotly dot-heatmap using scatter markers on categorical axes.</span>
	<span class="c1"># x: groups (columns), y: genes (rows)</span>
	<span class="n">x_labels</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">gene_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">y_labels</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;Gene&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">y_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gene_order</span> <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;Gene&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()]</span>

	<span class="c1"># Ensure ordering</span>
	<span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;x_cat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[</span><span class="n">group_col</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">x_labels</span><span class="p">)</span>
	<span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;y_cat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;Gene&#39;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">y_labels</span><span class="p">)</span>

	<span class="c1"># marker sizes: scale &#39;frac&#39; (0-1) to reasonable pixel sizes</span>
	<span class="n">frac_vals</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;frac&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
	<span class="n">sizes</span> <span class="o">=</span> <span class="p">(</span><span class="n">frac_vals</span> <span class="o">*</span> <span class="p">(</span><span class="n">size_max</span> <span class="o">-</span> <span class="n">size_min</span><span class="p">)</span> <span class="o">+</span> <span class="n">size_min</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

	<span class="c1"># marker colors: use Mean</span>
	<span class="n">mean_vals</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;Mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

	<span class="n">hover_text</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Group: </span><span class="si">{</span><span class="n">g</span><span class="si">}</span><span class="s2">&lt;br&gt;Gene: </span><span class="si">{</span><span class="n">ge</span><span class="si">}</span><span class="s2">&lt;br&gt;Mean: </span><span class="si">{</span><span class="n">m</span><span class="si">:</span><span class="s2">.4g</span><span class="si">}</span><span class="s2">&lt;br&gt;Frac: </span><span class="si">{</span><span class="n">f</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">g</span><span class="p">,</span><span class="n">ge</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;Gene&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">mean_vals</span><span class="p">,</span> <span class="n">frac_vals</span><span class="p">)]</span>
	<span class="n">vmin_quantile</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">vmin</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
	<span class="n">vmax_quantile</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">vmax</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
	<span class="n">marker_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">mean_vals</span><span class="p">,</span> <span class="n">colorscale</span><span class="o">=</span><span class="n">colorscale</span><span class="p">,</span> 
					<span class="n">showscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">),</span> 
					<span class="n">reversescale</span><span class="o">=</span><span class="n">reversescale</span><span class="p">,</span> <span class="n">sizemode</span><span class="o">=</span><span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
					<span class="n">cmin</span><span class="o">=</span><span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;Mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">vmin_quantile</span><span class="p">),</span>
					<span class="n">cmax</span><span class="o">=</span><span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;Mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">vmax_quantile</span><span class="p">)</span>
					<span class="p">)</span>

	<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
	<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
		<span class="n">x</span><span class="o">=</span><span class="n">plot_data</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
		<span class="n">y</span><span class="o">=</span><span class="n">plot_data</span><span class="p">[</span><span class="s1">&#39;Gene&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
		<span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
		<span class="n">marker</span><span class="o">=</span><span class="n">marker_dict</span><span class="p">,</span>
		<span class="n">text</span><span class="o">=</span><span class="n">hover_text</span><span class="p">,</span>
		<span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;text&#39;</span>
	<span class="p">))</span>

	<span class="c1"># Layout: categorical axes with explicit ordering</span>
	<span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="n">categoryorder</span><span class="o">=</span><span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="n">categoryarray</span><span class="o">=</span><span class="n">x_labels</span><span class="p">,</span> <span class="n">tickangle</span><span class="o">=</span> <span class="o">-</span><span class="mi">45</span><span class="p">)</span>
	<span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="n">categoryorder</span><span class="o">=</span><span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="n">categoryarray</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">y_labels</span><span class="p">)))</span>
	<span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">title</span><span class="o">=</span><span class="n">group_col</span>
	<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xaxis_title</span><span class="o">=</span><span class="n">group_col</span><span class="p">,</span> <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Gene&#39;</span><span class="p">,</span>
						<span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">show</span><span class="p">:</span>
		<span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;dotHeatmap.</span><span class="si">{</span><span class="n">group_col</span><span class="si">}</span><span class="s2">&quot;</span>
		<span class="n">show_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="get_boxplot_data">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.get_boxplot_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_boxplot_data</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="n">variable</span><span class="p">,</span><span class="n">gene</span><span class="p">,</span><span class="n">obs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
	<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">isbacked</span><span class="p">:</span> <span class="c1"># type: ignore</span>
		<span class="n">use_adata</span><span class="o">=</span><span class="n">adata</span><span class="p">[:,</span><span class="n">gene</span><span class="p">]</span><span class="o">.</span><span class="n">to_memory</span><span class="p">()</span> <span class="c1"># type: ignore</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">use_adata</span><span class="o">=</span><span class="n">adata</span><span class="p">[:,</span><span class="n">gene</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># type: ignore</span>
	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
		<span class="n">obs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">obs</span><span class="p">))</span>
		<span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">obs_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tsv&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obs_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;,&#39;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">obs_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
		<span class="n">data</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
	<span class="n">overlap_idx</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">use_adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">)</span>
	<span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">overlap_idx</span><span class="p">]</span>
	<span class="n">use_adata</span><span class="o">=</span><span class="n">use_adata</span><span class="p">[</span><span class="n">overlap_idx</span><span class="p">,:]</span> <span class="c1"># type: ignore</span>

	<span class="k">if</span> <span class="ow">not</span> <span class="n">gene</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">data</span><span class="p">[</span><span class="n">gene</span><span class="p">]</span><span class="o">=</span><span class="n">use_adata</span><span class="o">.</span><span class="n">to_df</span><span class="p">()[</span><span class="n">gene</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="c1"># type: ignore</span>
	<span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="n">variable</span><span class="p">,</span><span class="n">gene</span><span class="p">]]</span></div>

		
<div class="viewcode-block" id="has_stats">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.has_stats">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">has_stats</span><span class="p">(</span><span class="n">adata</span><span class="p">):</span>
	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
		<span class="n">adata</span><span class="o">=</span><span class="n">anndata</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="n">backed</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
	<span class="n">flag</span><span class="o">=</span><span class="kc">True</span>
	<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;q25&#39;</span><span class="p">,</span><span class="s1">&#39;q50&#39;</span><span class="p">,</span><span class="s1">&#39;q75&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;std&#39;</span><span class="p">]:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
			<span class="n">flag</span><span class="o">=</span><span class="kc">False</span>
			<span class="k">break</span>
	<span class="k">return</span> <span class="n">flag</span></div>


<div class="viewcode-block" id="plot_interactive_boxlot_from_data">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.plot_interactive_boxlot_from_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_interactive_boxlot_from_data</span><span class="p">(</span>
		<span class="n">adata</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">variable</span><span class="p">,</span><span class="n">gene</span><span class="p">,</span><span class="n">palette_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">width</span><span class="o">=</span><span class="mi">1100</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="p">):</span>
	<span class="n">plot_df</span> <span class="o">=</span> <span class="n">get_boxplot_data</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="n">variable</span><span class="p">,</span><span class="n">gene</span><span class="p">,</span><span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">)</span>
	<span class="c1"># Preserve existing Y-axis extreme filtering logic (remove 1% and 99% extremes)</span>
	<span class="n">range_y</span><span class="o">=</span><span class="p">[</span><span class="n">plot_df</span><span class="p">[</span><span class="n">gene</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span> <span class="n">plot_df</span><span class="p">[</span><span class="n">gene</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.99</span><span class="p">)]</span>
	<span class="c1"># color_discrete_map=get_colors(adata,variable,palette_path=palette_path)</span>
	<span class="n">color_discrete_map</span><span class="o">=</span><span class="n">load_color_palette</span><span class="p">(</span><span class="n">palette_path</span><span class="o">=</span><span class="n">palette_path</span><span class="p">,</span><span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span><span class="n">groups</span><span class="o">=</span><span class="n">variable</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">color_discrete_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">keys</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">color_discrete_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="c1"># type: ignore</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">plot_df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
				<span class="k">del</span> <span class="n">color_discrete_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="c1"># type: ignore</span>
	<span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Boxplot: </span><span class="si">{</span><span class="n">gene</span><span class="si">}</span><span class="s2"> by </span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">&quot;</span>
	<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
		<span class="n">plot_df</span><span class="p">,</span>
		<span class="n">x</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span>
		<span class="n">y</span><span class="o">=</span><span class="n">gene</span><span class="p">,</span>
		<span class="n">color</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span>
		<span class="n">color_discrete_sequence</span><span class="o">=</span><span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">D3</span><span class="p">,</span> <span class="c1"># color palette (professional, unobtrusive)</span>
		<span class="n">color_discrete_map</span><span class="o">=</span><span class="n">color_discrete_map</span><span class="p">,</span>
		<span class="n">range_y</span><span class="o">=</span><span class="n">range_y</span><span class="p">,</span>
		<span class="n">points</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
		<span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
		<span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_white&quot;</span>   <span class="c1"># keep white background style</span>
	<span class="p">)</span>
	<span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">tickangle</span><span class="o">=-</span><span class="mi">90</span><span class="p">,</span> <span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

	<span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span>
		<span class="n">line_width</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>           <span class="c1"># thinner lines for a more refined look</span>
		<span class="n">notched</span><span class="o">=</span><span class="kc">False</span>               <span class="c1"># no notch, standard boxplot style</span>
	<span class="p">)</span>

	<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
		<span class="n">xaxis_title</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span>
		<span class="n">yaxis_title</span><span class="o">=</span><span class="n">gene</span><span class="p">,</span>
		<span class="n">legend_title</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span>
		<span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
		<span class="n">height</span><span class="o">=</span><span class="n">height</span>
	<span class="p">)</span>
	<span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="plot_interacrive_boxplot_from_stats">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.plot_interacrive_boxplot_from_stats">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_interacrive_boxplot_from_stats</span><span class="p">(</span>
		<span class="n">adata</span><span class="p">,</span><span class="n">variable</span><span class="p">,</span><span class="n">gene</span><span class="p">,</span><span class="n">palette_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">1100</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">):</span>
	<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">isbacked</span><span class="p">:</span> <span class="c1"># type: ignore</span>
		<span class="n">use_adata</span><span class="o">=</span><span class="n">adata</span><span class="p">[:,</span><span class="n">gene</span><span class="p">]</span><span class="o">.</span><span class="n">to_memory</span><span class="p">()</span> <span class="c1"># type: ignore</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">use_adata</span><span class="o">=</span><span class="n">adata</span><span class="p">[:,</span><span class="n">gene</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># type: ignore</span>
	<span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">isbacked</span><span class="p">:</span> <span class="c1"># type: ignore</span>
		<span class="n">adata</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># type: ignore</span>
	
	<span class="n">stat_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;q25&#39;</span><span class="p">,</span><span class="s1">&#39;q50&#39;</span><span class="p">,</span><span class="s1">&#39;q75&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;std&#39;</span><span class="p">]</span>
	<span class="n">plot_data</span><span class="o">=</span><span class="p">[]</span>
	<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">stat_keys</span><span class="p">:</span>
		<span class="n">df</span><span class="o">=</span><span class="n">use_adata</span><span class="o">.</span><span class="n">to_df</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="n">k</span><span class="p">)[</span><span class="n">gene</span><span class="p">]</span>
		<span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="n">k</span>
		<span class="n">plot_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
	<span class="n">plot_data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># rows are cell types and columns are stats</span>
	<span class="n">groups</span><span class="o">=</span><span class="n">plot_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;q50&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
	<span class="n">plot_data</span><span class="o">=</span><span class="n">plot_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">groups</span><span class="p">]</span>

	<span class="c1"># build figure with one Box per group using precomputed quartiles/fences</span>
	<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
	<span class="c1"># optional color mapping</span>
	<span class="c1"># color_discrete_map=get_colors(adata,variable,palette_path=palette_path)</span>
	<span class="n">color_discrete_map</span><span class="o">=</span><span class="n">load_color_palette</span><span class="p">(</span><span class="n">palette_path</span><span class="o">=</span><span class="n">palette_path</span><span class="p">,</span><span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span><span class="n">groups</span><span class="o">=</span><span class="n">variable</span><span class="p">)</span>
	<span class="n">palette</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">D3</span>
	<span class="n">color</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
		<span class="n">i</span><span class="o">=</span><span class="n">groups</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
		<span class="n">q1</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;q25&#39;</span><span class="p">]</span>
		<span class="n">med</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;q50&#39;</span><span class="p">]</span>
		<span class="n">q3</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;q75&#39;</span><span class="p">]</span>
		<span class="n">low</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span>
		<span class="n">high</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span>
		<span class="n">mean</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span>
		<span class="n">std</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">color_discrete_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">color_discrete_map</span><span class="p">:</span>
			<span class="n">color</span> <span class="o">=</span> <span class="n">color_discrete_map</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette</span><span class="p">)]</span>
		<span class="c1"># Box from precomputed stats (single-element arrays)</span>
		<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
			<span class="n">go</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
				<span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">group</span><span class="p">],</span>
				<span class="n">q1</span><span class="o">=</span><span class="p">[</span><span class="n">q1</span><span class="p">],</span>
				<span class="n">median</span><span class="o">=</span><span class="p">[</span><span class="n">med</span><span class="p">],</span>
				<span class="n">q3</span><span class="o">=</span><span class="p">[</span><span class="n">q3</span><span class="p">],</span>
				<span class="n">lowerfence</span><span class="o">=</span><span class="p">[</span><span class="n">low</span><span class="p">],</span>
				<span class="n">upperfence</span><span class="o">=</span><span class="p">[</span><span class="n">high</span><span class="p">],</span>
				<span class="n">boxpoints</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
				<span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">),</span>
				<span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">),</span>
				<span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span>
			<span class="p">)</span>
		<span class="p">)</span>
		<span class="c1"># mean as a scatter point with std error bar</span>
		<span class="c1"># fig.add_trace(</span>
		<span class="c1"># 	go.Scatter(</span>
		<span class="c1"># 		x=[group],</span>
		<span class="c1"># 		y=[mean],</span>
		<span class="c1"># 		mode=&#39;markers&#39;,</span>
		<span class="c1"># 		marker=dict(symbol=&#39;diamond&#39;, size=8, color=&#39;black&#39;),</span>
		<span class="c1"># 		error_y=dict(type=&#39;data&#39;, array=[std], visible=True),</span>
		<span class="c1"># 		name=&#39;mean&#39;,</span>
		<span class="c1"># 		showlegend=False</span>
		<span class="c1"># 	)</span>
		<span class="c1"># )</span>
	<span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Boxplot: </span><span class="si">{</span><span class="n">gene</span><span class="si">}</span><span class="s2"> by </span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">&quot;</span>
	<span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">tickangle</span><span class="o">=-</span><span class="mi">90</span><span class="p">,</span> <span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
		<span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
		<span class="n">xaxis_title</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span>
		<span class="n">yaxis_title</span><span class="o">=</span><span class="n">gene</span><span class="p">,</span>
		<span class="n">legend_title</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span>
		<span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span><span class="p">,</span>
		<span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
		<span class="n">height</span><span class="o">=</span><span class="n">height</span>
	<span class="p">)</span>
	<span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="interactive_boxplot">
<a class="viewcode-back" href="../../adataviz.plotting.html#adataviz.plotting.interactive_boxplot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">interactive_boxplot</span><span class="p">(</span>
		<span class="n">adata</span><span class="p">,</span><span class="n">variable</span><span class="p">,</span><span class="n">gene</span><span class="p">,</span><span class="n">obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">palette_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">1100</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;notebook&#39;</span><span class="p">):</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">renderer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">pio</span><span class="o">.</span><span class="n">renderers</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">renderer</span>
	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
		<span class="n">adata</span><span class="o">=</span><span class="n">anndata</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="n">backed</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span><span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">obs</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># type: ignore</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">has_stats</span><span class="p">(</span><span class="n">adata</span><span class="p">):</span>
		<span class="n">fig</span><span class="o">=</span><span class="n">plot_interactive_boxlot_from_data</span><span class="p">(</span>
		<span class="n">adata</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">variable</span><span class="p">,</span><span class="n">gene</span><span class="p">,</span><span class="n">palette_path</span><span class="o">=</span><span class="n">palette_path</span><span class="p">,</span>
		<span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="n">height</span>
		<span class="p">)</span>
	<span class="k">else</span><span class="p">:</span> <span class="c1"># pseudobulk level with precomputed stats</span>
		<span class="n">fig</span><span class="o">=</span><span class="n">plot_interacrive_boxplot_from_stats</span><span class="p">(</span>
			<span class="n">adata</span><span class="p">,</span><span class="n">variable</span><span class="p">,</span><span class="n">gene</span><span class="p">,</span><span class="n">palette_path</span><span class="o">=</span><span class="n">palette_path</span><span class="p">,</span>
			<span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">show</span><span class="p">:</span>
		<span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;boxplot.</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">gene</span><span class="si">}</span><span class="s2">&quot;</span>
		<span class="n">show_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">None</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">fig</span></div>

		
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2026, Wubin Ding, Amit Klein
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../_static/documentation_options.js?v=8a448e45"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../../_static/js/rtd_search_config.js"></script>
    <script src="../../_static/js/rtd_sphinx_search.min.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/plotly_scroll.js?v=212bb26b"></script>
    </body>
</html>